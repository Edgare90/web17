"use strict";var mockery=require("mockery");mockery.enable(),mockery.registerAllowables(["../src/js/converter/declarations.js","console","./utils.js","./domutils.js","console","../bower_components/mensch"]),mockery.registerMock("jquery",require("cheerio")),mockery.registerMock("mensch/lib/parser.js",function(){var e=require("../bower_components/mensch").parse;return e.apply(e,arguments)});var processStylesheetRules=require("../src/js/converter/stylesheet.js"),mockedWithBindingProvider=function(e,t,r,a){return"$"+e+"."+r+"["+a+"]"},blockDefsUpdater=function(){console.log("BDU",arguments)},themeUpdater=function(){console.log("TU",arguments)};describe("Stylesheet declaration processor",function(){it('should add "namespacing" to every rule',function(){var e;e=processStylesheetRules("a { b: c }",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{ b: c }"),e=processStylesheetRules("a{b:c}",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{b:c}"),e=processStylesheetRules("a, b { b: c } @media all { c { d: e } }",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a, <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->b{ b: c } @media all { <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->c{ d: e } }")}),it("should process simple -ko properties",function(){var e;e=processStylesheetRules("a { b: c; -ko-b: @myc }",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{ b: c; b: <!-- ko text: $block.myc[c]() -->c<!-- /ko -->}"),e=processStylesheetRules("prova{color: #3f3f3f;-ko-color:@['#3f3f3f'];}\r\nprova{color: #3f3f3f;-ko-color:@['#3f3f3f'];}",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->prova{color: #3f3f3f;color: <!-- ko text: '#3f3f3f' -->#3f3f3f<!-- /ko -->;}\r\n<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->prova{color: #3f3f3f;color: <!-- ko text: '#3f3f3f' -->#3f3f3f<!-- /ko -->;}")}),it("should process [data-ko-block=] directive",function(){var e,t=jasmine.createSpy("blockDefsUpdater");e=processStylesheetRules("a[data-ko-block=foo] { b: c; -ko-b: @myc }",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{ b: c; b: <!-- ko text: $foo.myc[c]() -->c<!-- /ko --> } <!-- /ko -->"),expect(t).toHaveBeenCalledWith("foo","",{contextName:"block"}),e=processStylesheetRules("a[data-ko-block=foo], [data-ko-block=foo] a { b: c; -ko-b: @myc }",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->, <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko --><!-- ko text: '#'+id() -->foo<!-- /ko --> a{ b: c; b: <!-- ko text: $foo.myc[c]() -->c<!-- /ko --> } <!-- /ko -->"),e=processStylesheetRules("a[data-ko-block=foo],\n [data-ko-block=foo] a { b: c; -ko-b: @myc }",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->, <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko --><!-- ko text: '#'+id() -->foo<!-- /ko --> a{ b: c; b: <!-- ko text: $foo.myc[c]() -->c<!-- /ko --> } <!-- /ko -->"),e=processStylesheetRules("a[data-ko-block=foo]{}b[data-ko-block=foo]{}",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{} <!-- /ko --><!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->b<!-- ko text: '#'+id() -->foo<!-- /ko -->{} <!-- /ko -->"),e=processStylesheetRules("a[data-ko-block=foo] { } b[data-ko-block=foo] { } ",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{ }  <!-- /ko --><!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->b<!-- ko text: '#'+id() -->foo<!-- /ko -->{ }  <!-- /ko -->"),e=processStylesheetRules("a[data-ko-block=foo]{\n}b[data-ko-block=foo]{\n}",void 0,mockedWithBindingProvider,t,themeUpdater,".","template","block"),expect(e).toEqual("<!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{\n} <!-- /ko --><!-- ko foreach: $root.findObjectsOfType($data, 'foo') --> <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->b<!-- ko text: '#'+id() -->foo<!-- /ko -->{\n} <!-- /ko -->")}),it("should throw error on multiple different [data-ko-block=] directive",function(){var e,t;try{e=processStylesheetRules("a[data-ko-block=foo], b[data-ko-block=bar] { b: c; -ko-b: @myc }",void 0,mockedWithBindingProvider,blockDefsUpdater,themeUpdater,".","template","block")}catch(r){t=r}expect(e).toBe(void 0),expect(t).toMatch(/^Found multiple/)}),it("should process multiline [data-ko-block=] directive",function(){var e;e=processStylesheetRules("    a[data-ko-block=foo] {\n      b: c;\n      -ko-b: @myc\n    }\n",void 0,mockedWithBindingProvider,blockDefsUpdater,themeUpdater,".","template","block"),expect(e).toEqual("    <!-- ko foreach: $root.findObjectsOfType($data, 'foo') -->\n    <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{\n      b: c;\n      b: <!-- ko text: $foo.myc[c]() -->c<!-- /ko -->\n    }\n    <!-- /ko -->"),e=processStylesheetRules("    f { g: h; }\n    i{j:k}\n    a[data-ko-block=foo] {\n      b: c;\n      -ko-b: @myc\n    }\n",void 0,mockedWithBindingProvider,blockDefsUpdater,themeUpdater,".","template","block"),expect(e).toEqual("    <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->f{ g: h; }\n    <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->i{j:k}\n    <!-- ko foreach: $root.findObjectsOfType($data, 'foo') -->\n    <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a<!-- ko text: '#'+id() -->foo<!-- /ko -->{\n      b: c;\n      b: <!-- ko text: $foo.myc[c]() -->c<!-- /ko -->\n    }\n    <!-- /ko -->"),e=processStylesheetRules("\n    [data-ko-block=tripleArticleBlock] .links-color a,\n    [data-ko-block=tripleArticleBlock] .links-color a:hover {\n      color: #3f3f3f;\n      -ko-color: @longTextStyle.linksColor;\n      text-decoration: underline;\n    }\na{b:c}",void 0,mockedWithBindingProvider,blockDefsUpdater,themeUpdater,".","template","block"),expect(e).toEqual("\n    <!-- ko foreach: $root.findObjectsOfType($data, 'tripleArticleBlock') -->\n    <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko --><!-- ko text: '#'+id() -->tripleArticleBlock<!-- /ko --> .links-color a, <!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko --><!-- ko text: '#'+id() -->tripleArticleBlock<!-- /ko --> .links-color a:hover{\n      color: #3f3f3f;\n      color: <!-- ko text: $tripleArticleBlock.longTextStyle.linksColor[#3f3f3f]() -->#3f3f3f<!-- /ko -->;\n      text-decoration: underline\n    }\n    <!-- /ko --><!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{b:c}")}),it("should ignore comments or unknown rules but keep them",function(){var e;e=processStylesheetRules("/* first */a { b: c; /* second */-ko-b: @myc }/* third */",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("/* first */<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{ b: c; /* second */b: <!-- ko text: $block.myc[c]() -->c<!-- /ko -->}/* third */"),e=processStylesheetRules("@keyframes{a{-ko-b:@c}}a {b:c}",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("@keyframes{a{-ko-b:@c}}<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{b:c}")}),it("should parse unsupported supports rules",function(){var e;e=processStylesheetRules("@supports cips {a{b:1;-ko-b:@myb}}a {b:c}",void 0,mockedWithBindingProvider,void 0,void 0,".","template","block"),expect(e).toEqual("@supports cips {<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{b:1;b: <!-- ko text: $block.myb[1]() -->1<!-- /ko -->}}<!-- ko text: templateMode =='wysiwyg' ? '#main-wysiwyg-area ' : '' --><!-- /ko -->a{b:c}")}),it("should parse -ko-blockdefs definitions",function(){var e,t=jasmine.createSpy("blockDefsUpdater");e=processStylesheetRules("@supports -ko-blockdefs { color { widget: color } color:preview { -ko-color: @color } }",void 0,mockedWithBindingProvider,t,void 0,".","template","block"),expect(e).toEqual(""),expect(t).toHaveBeenCalledWith("color","",{widget:"color"}),expect(t).toHaveBeenCalledWith("color",void 0,{previewBindings:[{type:"property",name:"-ko-color",value:"@color",position:{start:{line:1,col:67},end:{line:1,col:85}}}]})}),it("should parse -ko-blockdefs definitions, even empty declarations",function(){var e,t=jasmine.createSpy("blockDefsUpdater");e=processStylesheetRules("@supports -ko-blockdefs { color { } }",void 0,mockedWithBindingProvider,t,void 0,".","template","block"),expect(t).toHaveBeenCalledWith("color","",{}),expect(e).toEqual("")}),it("should raise an error when mixing preview selctor with other declarations",function(){var e,t;try{e=processStylesheetRules("@supports -ko-blockdefs { color, color:preview { } }",void 0,mockedWithBindingProvider,blockDefsUpdater,void 0,".","template","block")}catch(r){t=r}expect(e).toBeUndefined(),expect(t).toMatch(/^Cannot mix/)})});