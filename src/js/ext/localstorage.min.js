"use strict";var console=require("console"),ko=require("knockout"),$=require("jquery"),lsLoader=function(e,t){var i=global.localStorage.getItem("metadata-"+e);if(null!==i){var r,n=global.localStorage.getItem("template-"+e);null!==n&&(r=JSON.parse(n));var o=JSON.parse(i);return{metadata:o,model:r,extension:lsCommandPluginFactory(o,t)}}throw"Cannot find stored data for "+e},lsCommandPluginFactory=function(e,t){var i=function(e,i,r){var n={name:"Save",enabled:ko.observable(!0)};n.execute=function(){n.enabled(!1),r.metadata.changed=Date.now(),"undefined"==typeof r.metadata.key&&(console.warn("Unable to find ket in metadata object...",r.metadata),r.metadata.key=e),global.localStorage.setItem("metadata-"+e,r.exportMetadata()),global.localStorage.setItem("template-"+e,r.exportJSON()),n.enabled(!0)};var o={name:"Test",enabled:ko.observable(!0)},a={name:"Download",enabled:ko.observable(!0)};o.execute=function(){o.enabled(!1);var n=global.localStorage.getItem("testemail");if((null===n||"null"==n)&&(n=r.t("Insert here the recipient email address")),n=global.prompt(r.t("Test email address"),n),n.match(/@/)){global.localStorage.setItem("testemail",n),console.log("TODO testing...",n);var a=t?t:"/dl/",s=$.post(a,{action:"email",rcpt:n,subject:"[test] "+e+" - "+i,html:r.exportHTML()},null,"html");s.fail(function(){console.log("fail",arguments),r.notifier.error(r.t("Unexpected error talking to server: contact us!"))}),s.success(function(){console.log("success",arguments),r.notifier.success(r.t("Test email sent..."))}),s.always(function(){o.enabled(!0)})}else global.alert(r.t("Invalid email address")),o.enabled(!0)},a.execute=function(){a.enabled(!1),r.notifier.info(r.t("Downloading...")),r.exportHTMLtoTextarea("#downloadHtmlTextarea");var e=t?t:"/dl/";global.document.getElementById("downloadForm").setAttribute("action",e),global.document.getElementById("downloadForm").submit(),a.enabled(!0)},r.save=n,r.test=o,r.download=a}.bind(void 0,e.key,e.name);return i};module.exports=lsLoader;