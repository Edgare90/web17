"use strict";function _viewModelPluginInstance(e){var t;return{viewModel:function(i){t=e(i)},init:function(){"undefined"!=typeof t&&"undefined"!=typeof t.init&&t.init()},dispose:function(){"undefined"!=typeof t&&"undefined"!=typeof t.dispose&&t.dispose()}}}var $=require("jquery"),ko=require("knockout"),kojqui=require("knockout-jqueryui"),templateConverter=require("./converter/main.js"),console=require("console"),initializeViewmodel=require("./viewmodel.js"),templateSystem=require("./bindings/choose-template.js"),pluginsCall=function(e,t,i,r){var a,o,n,s,l;l=[],"undefined"!=typeof r&&r?(a=e.length-1,o=0,n=-1):(a=0,o=e.length-1,n=1);for(var d=a;d!=o+n;d+=n)"undefined"!=typeof e[d][t]&&(s=e[d][t].apply(e[d],i),"undefined"!=typeof s&&l.push(s));return l},origDisposeCallback=ko.utils.domNodeDisposal.addDisposeCallback;ko.utils.domNodeDisposal.addDisposeCallback=function(e,t){var i=function(e){try{t(e)}catch(i){console.warn("Caught unexpected dispose callback exception",i)}};origDisposeCallback(e,i)};var bindingPluginMaker=function(e){return{viewModel:function(t){try{e("applyBindings",ko.applyBindings.bind(void 0,t))}catch(i){throw console.warn(i,i.stack),i}},dispose:function(){try{e("unapplyBindings",ko.cleanNode.bind(this,global.document.body))}catch(t){throw console.warn(t,t.stack),t}}}},templateCreator=function(e,t,i,r){var a=i;for("undefined"!=typeof i&&"undefined"!=typeof r&&("object"!=typeof t||"replacedhtml"!=t.tagName.toLowerCase())&&(a+="-"+r);"undefined"==typeof a||null===a||e.exists(a);)a="anonymous-"+Math.floor(1e5*Math.random()+1);if("object"==typeof t&&"replacedhtml"==t.tagName.toLowerCase()){var o=$(t),n=$("replacedhead",o),s=$("replacedbody",o);e.adder(a+"-head",n.html()||""),e.adder(a+"-show",s.html()||""),e.adder(a+"-preview",o.html()),e.adder(a+"-wysiwyg",o.html()),n.children().detach(),n.html("<!-- ko block: content --><!-- /ko -->"),n.before("<!-- ko withProperties: { templateMode: 'head' } -->"),n.after("<!-- /ko -->"),s.html("<!-- ko block: content --><!-- /ko -->"),e.adder(a+"-iframe",o[0].outerHTML)}else"object"==typeof t?e.adder(a,t.outerHTML):e.adder(a,t);return a},_templateUrlConverter=function(e,t){return t.match(/^[^\/]*:/)||t.match(/^\//)||t.match(/^\[/)||t.match(/^#?$/)?null:e+t},templateLoader=function(e,t,i,r,a,o){var n="string"==typeof t?t:i.template,s="./",l=n.lastIndexOf("/");-1!=l&&(s=n.substr(0,l+1));var c,d=_templateUrlConverter.bind(void 0,s);c="undefined"==typeof i?{template:n,name:"No name",created:Date.now()}:i,$.get(n,function(t){var i=templateCompiler(e,d,"template",t,r,c,a,o);i.init()})},templateCompiler=function(e,t,i,r,a,o,n,s){var l=r.match(/^([\S\s]*)([<]html[^>]*>[\S\s]*<\/html>)([\S\s]*)$/i);if(null===l)throw"Unable to find <html> opening and closing tags in the template";var d=l[1],c={"<html":0,"<head":0,"<body":0,"</html":0,"</body":0,"</head":0},u=l[2].replace(/(<\/?)(html|head|body)([^>]*>)/gi,function(e,t,i,r){return c[(t+i).toLowerCase()]+=1,t+"replaced"+i+r});for(var v in c)if(c.hasOwnProperty(v)&&1!=c[v]){if(0===c[v])throw"ERROR: missing mandatory element "+v+">";if(c[v]>1)throw"ERROR: multiple element "+v+"> occourences are not supported (found "+c[v]+" occourences)"}var f=l[3],p=[],b="+$root.contentListeners()",g=[];if("undefined"!=typeof n)for(var y=0;y<n.length;y++)"function"==typeof n[y]?g.push(_viewModelPluginInstance(n[y])):g.push(n[y]);var w=[],x={adder:function(e,t){if("string"!=typeof t)throw"Template system: cannot create new template "+e;var i=t.match(/(data)?-ko-[^ =:]*/g);i&&console.error("ERROR: found unexpected -ko- attribute in compiled template",e,", you probably mispelled it:",i),templateSystem.addTemplate(e,t),w.push(e)},exists:function(e){var t=templateSystem.getTemplateContent(e);return"undefined"!=typeof t?!0:!1},dispose:function(){for(var e=w.length-1;e>=0;e--)templateSystem.removeTemplate(w[e])}};ko.bindingHandlers.block.templateExists=x.exists;for(var k=templateCreator.bind(void 0,x),C=e("translateTemplate",templateConverter.translateTemplate.bind(void 0,i,u,t,k)),S=e("generateModel",templateConverter.wrappedResultModel.bind(void 0,C)),_={},E=pluginsCall(g,"widget",[$,ko,kojqui]),D=0;D<E.length;D++)_[E[D].widget]=E[D];p.push.apply(p,e("generateEditors",templateConverter.generateEditors.bind(void 0,C,_,t,k,b)));var T=!1;if("undefined"!=typeof a&&null!==a){var F;F="string"==typeof a?ko.utils.parseJson(a):a;var M=e("checkModel",templateConverter.checkModel.bind(void 0,S._unwrap(),p,F));2==M&&(console.error("Trying to compile an incompatible template version!",S._unwrap(),p,F),T=!0);try{S._wrap(F)}catch(I){console.error("Unable to inject model content!",I),T=!0}}var P=d+templateSystem.getTemplateContent(i+"-iframe").replace(/(<\/?)replaced(html|head|body)([^>]*>)/gi,function(e,t,i,r){return t+i+r})+f,j=ko.bindingHandlers.bindIframe.tpl;ko.bindingHandlers.bindIframe.tpl=P;var O={dispose:function(){ko.bindingHandlers.bindIframe.tpl=j}};g.push(O),g.push(x);var z=e("initializeViewmodel",initializeViewmodel.bind(this,S,p,t,s));z.metadata=o;var H="0.16.0";return"undefined"!=typeof z.metadata.editorversion&&z.metadata.editorversion!==H&&console.warn("The model being loaded has been created with an older editor version",z.metadata.editorversion,"vs",H),z.metadata.editorversion=H,"undefined"!=typeof C.version&&("undefined"!=typeof z.metadata.templateversion&&z.metadata.templateversion!==C.version&&console.error("The model being loaded has been created with a different template version",C.version,"vs",z.metadata.templateversion),z.metadata.templateversion=C.version),templateSystem.init(),g.push(bindingPluginMaker(e)),pluginsCall(g,"viewModel",[z]),T&&$("#incompatible-template").dialog({modal:!0,appendTo:"#mo-body",buttons:{Ok:function(){$(this).dialog("close")}}}),{model:z,init:function(){pluginsCall(g,"init",void 0,!0)},dispose:function(){pluginsCall(g,"dispose",void 0,!0)}}},checkFeature=function(e,t){if(!t())throw console.warn("Missing feature",e),"Missing feature "+e},isCompatible=function(){try{return checkFeature("matchMedia",function(){return"undefined"!=typeof global.matchMedia}),checkFeature("XMLHttpRequest 2",function(){return"XMLHttpRequest"in global&&"withCredentials"in new global.XMLHttpRequest}),checkFeature("ES5 strict",function(){return function(){return"undefined"==typeof this}()}),checkFeature("CSS borderRadius",function(){return"undefined"!=typeof global.document.body.style.borderRadius}),checkFeature("CSS boxShadow",function(){return"undefined"!=typeof global.document.body.style.boxShadow}),checkFeature("CSS boxSizing",function(){return"undefined"!=typeof global.document.body.style.boxSizing}),checkFeature("CSS backgroundSize",function(){return"undefined"!=typeof global.document.body.style.backgroundSize}),checkFeature("CSS backgroundOrigin",function(){return"undefined"!=typeof global.document.body.style.backgroundOrigin}),checkBadBrowserExtensions(),!0}catch(e){return!1}},checkBadBrowserExtensions=function(){var e="checkbadbrowsersframe",t=ko.bindingHandlers.bindIframe.tpl;ko.bindingHandlers.bindIframe.tpl='<!DOCTYPE html>\r\n<html>\r\n<head><title>A</title>\r\n</head>\r\n<body><p style="color: blue" align="right" data-bind="style: { color: \'red\' }">B</p><div data-bind="text: content"></div></body>\r\n</html>\r\n',$("body").append('<iframe id="'+e+'" data-bind="bindIframe: $data"></iframe>');var i=global.document.getElementById(e);ko.applyBindings({content:"dummy content"},i);var r=i.contentWindow.document.doctype,a="<!DOCTYPE "+r.name+(r.publicId?' PUBLIC "'+r.publicId+'"':"")+(!r.publicId&&r.systemId?" SYSTEM":"")+(r.systemId?' "'+r.systemId+'"':"")+">",o=a+"\n"+i.contentWindow.document.documentElement.outerHTML;ko.cleanNode(i),ko.removeNode(i),ko.bindingHandlers.bindIframe.tpl=t;var n='<!DOCTYPE html>\n<html><head><title>A</title>\n</head>\n<body><p align="right" style="color: red;" data-bind="style: { color: \'red\' }">B</p><div data-bind="text: content">dummy content</div>\n\n</body></html>',s='<!DOCTYPE html>\n<html><head><title>A</title>\n</head>\n<body><p style="color: red;" data-bind="style: { color: \'red\' }" align="right">B</p><div data-bind="text: content">dummy content</div>\n\n</body></html>',l='<!DOCTYPE html>\n<html><head><title>A</title>\n</head>\n<body><p style="color: red;" align="right" data-bind="style: { color: \'red\' }">B</p><div data-bind="text: content">dummy content</div>\n\n</body></html>';if(n!==o&&s!==o&&l!==o)throw console.info("BadBrowser.FrameContentCheck",o.length,n.length,s.length,l.length,o==n,o==s,o==l),console.info(o),"Unexpected frame content. Misbehaving browser: "+o.length+"/"+n.length+"/"+s.length+"/"+l.length},fixPageEvents=function(){global.addEventListener&&(global.addEventListener("drag",function(e){e=e||global.event,e.preventDefault()},!1),global.addEventListener("dragstart",function(e){e=e||global.event,e.preventDefault()},!1),global.addEventListener("dragover",function(e){e=e||global.event,e.preventDefault()},!1),global.addEventListener("drop",function(e){e=e||global.event,e.preventDefault()},!1),global.document.body.addEventListener("drop",function(e){e.preventDefault()},!1)),global.document.ondragstart&&(global.document.ondragstart=function(){return!1})};module.exports={compile:templateCompiler,load:templateLoader,isCompatible:isCompatible,fixPageEvents:fixPageEvents};