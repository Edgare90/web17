"use strict";function _canonicalize(e){var t=global.document.createElement("div");return t.innerHTML="<a></a>",t.firstChild.href=e,t.innerHTML=t.innerHTML,t.firstChild.href}function _appendUrlParameters(e,t){var i=-1==e.indexOf("?")?"?":"&",r=e;for(var a in t)t.hasOwnProperty(a)&&(r+=i+a+"="+encodeURIComponent(t[a]),i="&");return r}var templateLoader=require("./template-loader.js"),console=require("console"),ko=require("knockout"),$=require("jquery");require("./ko-bindings.js");var performanceAwareCaller=require("./timed-call.js").timedCall,addUndoStackExtensionMaker=require("./undomanager/undomain.js"),colorPlugin=require("./ext/color.js"),inlinerPlugin=require("./ext/inliner.js"),localStorageLoader=require("./ext/localstorage.js");if("undefined"==typeof ko)throw"Cannot find knockout.js library!";if("undefined"==typeof $)throw"Cannot find jquery library!";var applyBindingOptions=function(e,t){t.bindingHandlers.wysiwygSrc.convertedUrl=function(t,i,r,a){var o,n=e.imgProcessorBackend?e.imgProcessorBackend:"./upload",s=n.match(/^(https?:\/\/[^\/]*\/).*$/),l=t.match(/^(https?:\/\/[^\/]*\/).*$/);if(null===s||null!==l&&s[1]==l[1])return o=-1==n.indexOf("?")?"?":"&",_appendUrlParameters(n,{src:t,method:i,params:r+","+a});console.log("Cannot apply backend image resizing to non-local resources ",t,i,r,a,s,l);var d={method:i,width:r};return null!==a&&(d.height=a),_appendUrlParameters(t,d)},t.bindingHandlers.wysiwygSrc.placeholderUrl=function(t,i,r){var a=e.imgProcessorBackend?e.imgProcessorBackend:"./upload";return _appendUrlParameters(a,{method:"placeholder",params:t+","+i})},e&&e.tinymceConfig&&(t.bindingHandlers.wysiwyg.standardOptions=e.tinymceConfig),e&&e.tinymceConfigFull&&(t.bindingHandlers.wysiwyg.fullOptions=e.tinymceConfigFull)},start=function(e,t,i,r,a){templateLoader.fixPageEvents();var o=function(t){var i={messages:{unknownError:t.t("Unknown error"),uploadedBytes:t.t("Uploaded bytes exceed file size"),maxNumberOfFiles:t.t("Maximum number of files exceeded"),acceptFileTypes:t.t("File type not allowed"),maxFileSize:t.t("File is too large"),minFileSize:t.t("File is too small"),post_max_size:t.t("The uploaded file exceeds the post_max_size directive in php.ini"),max_file_size:t.t("File is too big"),min_file_size:t.t("File is too small"),accept_file_types:t.t("Filetype not allowed"),max_number_of_files:t.t("Maximum number of files exceeded"),max_width:t.t("Image exceeds maximum width"),min_width:t.t("Image requires a minimum width"),max_height:t.t("Image exceeds maximum height"),min_height:t.t("Image requires a minimum height"),abort:t.t("File upload aborted"),image_resize:t.t("Failed to resize image"),generic:t.t("Unexpected upload error")}};e&&e.fileuploadConfig&&(i=$.extend(!0,i,e.fileuploadConfig)),ko.bindingHandlers.fileupload.extendOptions=i},n=function(t){e&&e.strings&&(t.t=function(i,r){var a=e.strings[i];return"undefined"==typeof a&&(console.warn("Missing translation string for",i,": using default string"),a=i),t.tt(a,r)})},s=[n,addUndoStackExtensionMaker(performanceAwareCaller),colorPlugin,inlinerPlugin];if("undefined"!=typeof a)for(var l=0;l<a.length;l++)s.push(a[l]);s.push(o);var d=e.fileuploadConfig?e.fileuploadConfig.url:"/upload/";applyBindingOptions(e,ko),$("<!-- ko template: 'main' --><!-- /ko -->").appendTo(global.document.body),"undefined"==typeof t&&"undefined"!=typeof i&&(t=i.template),templateLoader.load(performanceAwareCaller,t,i,r,s,d)},initFromLocalStorage=function(e,t,i){try{var r=localStorageLoader(t,e.emailProcessorBackend),a="undefined"!=typeof i?i:[];a.push(r.extension);var o=_canonicalize(r.metadata.template);start(e,o,r.metadata,r.model,a)}catch(n){console.error("TODO not found ",t,n)}},init=function(e,t){var i=global.location.hash?global.location.href.split("#")[1]:void 0;if(e&&(e.template||e.data))if(e.data){var r=JSON.parse(e.data);start(e,void 0,r.metadata,r.content,t)}else start(e,e.template,void 0,void 0,t);else if(i&&7==i.length)initFromLocalStorage(e,i,t);else{if(!i)return!1;start(e,_canonicalize(i),void 0,void 0,t)}return!0};module.exports={isCompatible:templateLoader.isCompatible,init:init,start:start};