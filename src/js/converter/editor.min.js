"use strict";var console=require("console"),elaborateDeclarations=require("./declarations.js"),utils=require("./utils.js"),modelDef=require("./model.js"),_getOptionsObject=function(e){for(var t=e.split("|"),i={},r=0;r<t.length;r++){var a=t[r].split("=");i[a[0]]=a.length>1?a[1]:a[0]}return i},_filterProps=function(e,t,i){var r=[];for(var a in e)if(!a.match(/^customStyle$/)&&!a.match(/^_/)&&e.hasOwnProperty(a)){var o=null!==e[a]&&"undefined"!=typeof e[a]._category&&"style"==e[a]._category;if("id"==a||"type"==a||a.match(/Blocks$/));else if("styler"==t)(o||i>0)&&r.push(a);else if("edit"==t){var n=null!==e[a]&&"undefined"!=typeof e[a]._category&&"content"==e[a]._category&&("undefined"==typeof e[a]._context||"block"!=e[a]._context);n&&r.push(a)}else"undefined"==typeof t&&r.push(a)}return r},_propInput=function(e,t,i,r,a){var n,o="";if(null!==e&&"undefined"!=typeof e._widget&&(n=e._widget),"undefined"==typeof n)throw"Unknown data type for "+t;var s="focusable: true";if("edit"==r&&(s+=", event: { focus: function(ui, event) { $($element).click(); } } "),o+='<label class="data-'+n+'"'+("boolean"==n?" data-bind=\"event: { mousedown: function(ui, evt) { if (evt.button == 0) { var input = $($element).find('input'); var ch = input.prop('checked'); setTimeout(function() { input.click(); input.prop('checked', !ch); input.trigger('change'); }, 0); } } }, click: function(ui, evt) { evt.preventDefault(); }, clickBubble: false\"":"")+">","undefined"!=typeof a&&"undefined"!=typeof a[n]){var l=a[n],d={};if("undefined"!=typeof l.parameters)for(var c in l.parameters)l.parameters.hasOwnProperty(c)&&"undefined"!=typeof e["_"+c]&&(d[c]=e["_"+c]);o+=l.html(i,s,d)}else if("boolean"==n)o+='<input type="checkbox" value="nothing" data-bind="checked: '+i+", "+s+'" />',o+='<span class="checkbox-replacer" ></span>';else if("color"==n)o+='<input size="7" type="text" data-bind="colorpicker: { color: '+i+", strings: $root.t('Theme Colors,Standard Colors,Web Colors,Theme Colors,Back to Palette,History,No history yet.') }, , "+s+'" />';else if("select"==n){if("undefined"!=typeof e._options){var u=_getOptionsObject(e._options);o+='<select data-bind="value: '+i+", "+s+'">';for(var f in u)u.hasOwnProperty(f)&&(o+='<option value="'+f+"\" data-bind=\"text: $root.ut('template', '"+utils.addSlashes(u[f])+"')\">"+u[f]+"</option>");o+="</select>"}}else if("font"==n)o+='<select type="text" data-bind="value: '+i+", "+s+'">',o+='<optgroup label="Sans-Serif Fonts">',o+='<option value="Arial,Helvetica,sans-serif">Arial</option>',o+="<option value=\"'Comic Sans MS',cursive,sans-serif\">Comic Sans MS</option>",o+='<option value="Impact,Charcoal,sans-serif">Impact</option>',o+="<option value=\"'Trebuchet MS',Helvetica,sans-serif\">Trebuchet MS</option>",o+='<option value="Verdana,Geneva,sans-serif">Verdana</option>',o+="</optgroup>",o+='<optgroup label="Serif Fonts">',o+='<option value="Georgia,serif">Georgia</option>',o+="<option value=\"'Times New Roman',Times,serif\">Times New Roman</option>",o+="</optgroup>",o+='<optgroup label="Monospace Fonts">',o+="<option value=\"'Courier New',Courier,monospace\">Courier New</option>",o+="</optgroup>",o+="</select>";else if("url"==n)o+='<div class="ui-textbutton">',o+='<input class="ui-textbutton-input" size="7" type="url" pattern="(mailto:.+@.+|https?://.+\\..+|\\[.*\\].*)" value="nothing" data-bind="css: { withButton: typeof $root.linkDialog !== \'undefined\' }, validatedValue: '+i+", "+s+'" />',o+="<a class=\"ui-textbutton-button\" data-bind=\"visible: typeof $root.linkDialog !== 'undefined', click: typeof $root.linkDialog !== 'undefined' ? $root.linkDialog.bind($element.previousSibling) : false, button: { icons: { primary: 'fa fa-fw fa-ellipsis-h' }, label: 'Opzioni', text: false }\">Opzioni</a>",o+="</div>";else if("integer"==n){var p=0,v=1e3;null!==e&&"undefined"!=typeof e._max&&(v=e._max),null!==e&&"undefined"!=typeof e._min&&(p=e._min);var h=v-p>=100?10:1,m=5*h;o+='<input class="number-spinner" size="7" step="'+h+'" type="number" value="-1" data-bind="spinner: { min: '+p+", max: "+v+", page: "+m+", value: "+i+" }, valueUpdate: ['change', 'spin'], "+s+'" />'}else o+='<input size="7" type="text" value="nothing" data-bind="value: '+i+", "+s+'" />';return o+="</label>"},_getGlobalStyleProp=function(e,t,i,r){var a;return("object"!=typeof t||null===t||"undefined"!=typeof t._widget)&&"undefined"!=typeof i&&"undefined"!=typeof r&&r.length>0&&"object"==typeof e&&"undefined"!=typeof e[r]&&(a=e[r]),a},_propEditor=function(e,t,i,r,a,o,n,s,l,d,c,u,f,p,v){if("undefined"==typeof l&&(l=0),"undefined"!=typeof n&&"object"==typeof r&&null!==r&&"undefined"==typeof r._usecount)return console.log("TODO EDITOR ignoring",o,"property because it is not used by the template","prop:",n,"type:",s,"level:",l,e._templateName),"";var g,h="undefined"!=typeof u?n+"._defaultComputed":n,m="",b=h,y=1,w=1;if("object"==typeof r&&null!==r&&"undefined"==typeof r._widget||"undefined"==typeof u&&(y+=1),"undefined"==typeof u&&"undefined"!=typeof d&&(w+=d),"undefined"!=typeof n&&f&&(m+="<!-- ko ifSubs: { data: "+b+", threshold: "+w+", gutter: "+y+" } -->"),"undefined"==typeof n||null!==r&&"undefined"!=typeof r._name||console.log("TODO WARN Missing label for property ",n),"undefined"==typeof n&&null!==r&&"undefined"==typeof r._name&&console.log("TODO WARN Missing label for object ",r.type),"object"==typeof r&&null!==r&&"undefined"==typeof r._widget){var k=_filterProps(r,s,l),x="styler"==s&&null!==r&&"undefined"!=typeof r.customStyle&&"undefined"!=typeof u,C="",S="";"undefined"!=typeof n&&"edit"==s&&(C=", click: function(obj, evt) { $root.selectItem("+n+", $data); return false }, clickBubble: false, css: { selecteditem: $root.isSelectedItem("+n+") }, scrollIntoView: $root.isSelectedItem("+n+"), ",S+=" selectable"),x&&(S+=" supportsCustomStyles"),m+='<div class="objEdit level'+l+S+'" data-bind="tooltips: {}'+C+'">';var _=null!==r&&"undefined"!=typeof r._name?r._name:"undefined"!=typeof n?"["+n+"]":"";if(x){var $="Stile";"undefined"!=typeof a&&null!==a&&"undefined"!=typeof a._name?$=a._name:console.log("TODO missing label for theme section ",n,null!==r?r.type:"-"),_="<span class=\"blockSelectionMethod\" data-bind=\"text: customStyle() ? $root.ut('template', '"+utils.addSlashes(_)+"') : $root.ut('template', '"+utils.addSlashes($)+"')\">Block</span>"}else _="<span data-bind=\"text: $root.ut('template', '"+utils.addSlashes(_)+"')\">"+_+"</span>";if(g=null!==r&&"undefined"!=typeof r._help?' title="'+utils.addSlashes(r._help)+"\" data-bind=\"attr: { title: $root.ut('template', '"+utils.addSlashes(r._help)+"') }\"":"",m+="<span"+g+' class="objLabel level'+l+'">'+_+"</span>","edit"==s&&"undefined"!=typeof r._blockDescription&&(m+="<div class=\"blockDescription\" data-bind=\"html: $root.ut('template', '"+utils.addSlashes(r._blockDescription)+"')\">"+r._blockDescription+"</div>"),x&&(m+='<label class="data-boolean blockCheck" data-bind="tooltips: { }">',m+='<input type="checkbox" value="nothing" data-bind="focusable: true, checked: customStyle" />',m+='<span title="Switch between global and block level styles editing" data-bind="attr: { title: $root.t(\'Switch between global and block level styles editing\') }" class="checkbox-replacer checkbox-replacer-onoff"></span>',m+="</label>",m+="<!-- ko template: { name: 'customstyle', if: customStyle } --><!-- /ko -->"),"undefined"!=typeof n&&(m+="<!-- ko with: "+n+" -->",1==l&&"undefined"!=typeof n&&"undefined"!=typeof r._previewBindings&&"undefined"!=typeof e)){"undefined"!=typeof p&&(m+='<!-- ko with: $root.content() --><div class="objPreview" data-bind="'+p+'"></div><!-- /ko -->'),"undefined"!=typeof v&&(m+='<!-- ko with: $parent --><div class="objPreview" data-bind="'+v+'"></div><!-- /ko -->');var E=elaborateDeclarations(void 0,r._previewBindings,i,e.bind(this,o+"."));m+='<div class="objPreview"><div class="objPreviewInner" data-bind="'+E+'"></div></div>'}var D;0===l&&"undefined"!=typeof r._previewBindings&&(D=elaborateDeclarations(void 0,r._previewBindings,i,e.bind(this,o.length>0?o+".":"")));var T,F,O,j,M=m.length;for(T=0;T<k.length;T++)F=o.length>0?o+"."+k[T]:k[T],("object"!=typeof r[k[T]]||null===r[k[T]]||"undefined"!=typeof r[k[T]]._widget)&&(j=void 0,0===l&&"theme"==k[T]?m+=_propEditor(e,t,i,r[k[T]],O,F,k[T],s,0,d,void 0,void 0,f,p):(j=_getGlobalStyleProp(c,r[k[T]],k[T],F),m+=_propEditor(e,t,i,r[k[T]],O,F,k[T],s,l+1,d,c,j,f,p,D)));for(T=0;T<k.length;T++)F=o.length>0?o+"."+k[T]:k[T],"object"==typeof r[k[T]]&&null!==r[k[T]]&&"undefined"==typeof r[k[T]]._widget&&(j=void 0,0===l&&"theme"==k[T]?m+=_propEditor(e,t,i,r[k[T]],O,F,k[T],s,0,d,void 0,void 0,f,p):(j=_getGlobalStyleProp(c,r[k[T]],k[T],F),m+=_propEditor(e,t,i,r[k[T]],O,F,k[T],s,l+1,d,c,j,f,p,D)));var I=m.length-M;if(0===I){if("object"==typeof r&&null!==r&&"template"==r._context)return"";m+='<div class="objEmpty" data-bind="html: $root.t(\'Selected element has no editable properties\')">Selected element has no editable properties</div>'}"undefined"!=typeof n&&(m+="<!-- /ko -->"),m+="</div>"}else{var A=!0;if("undefined"==typeof c&&(A=!1),null===r||"object"!=typeof r||"undefined"!=typeof r._widget){var P=[];"undefined"!=typeof u&&P.push("css: { notnull: "+n+"() !== null }"),g=null!==r&&"undefined"!=typeof r._help?' title="'+utils.addSlashes(r._help)+"\" data-bind=\"attr: { title: $root.ut('template', '"+utils.addSlashes(r._help)+"') }\"":"",g.length>0&&P.push("tooltips: {}");var z=P.length>0?'data-bind="'+utils.addSlashes(P.join())+'"':"";m+='<div class="propEditor '+(A?"checkboxes":"")+'"'+z+">";var L=null!==r&&"undefined"!=typeof r._name?r._name:"undefined"!=typeof n?"["+n+"]":"";L="<span data-bind=\"text: $root.ut('template', '"+utils.addSlashes(L)+"')\">"+L+"</span>",m+="<span"+g+' class="propLabel">'+L+"</span>",m+='<div class="propInput '+("undefined"!=typeof c?"local":"")+'" data-bind="css: { default: '+n+'() === null }">',m+=_propInput(r,n,h,s,t),m+="</div>","undefined"!=typeof u&&(m+='<div class="propInput global" data-bind="css: { overridden: '+n+'() !== null }">',m+=_propInput(r,n,u,s,t),m+="</div>",A&&(m+='<div class="propCheck"><label data-bind="tooltips: {}"><input type="checkbox" data-bind="focusable: true, click: function(evt, obj) { $root.localGlobalSwitch('+n+", "+u+"); return true; }, checked: "+n+'() !== null">',m+='<span class="checkbox-replacer" data-bind="css: { checked: '+n+"() !== null }, attr: { title: $root.t('This style is specific for this block: click here to remove the custom style and revert to the theme value') }\"></span>",m+="</label></div>")),m+="</div>"}else m+=null===r||"object"!=typeof r?'<div class="propEditor unknown">[A|'+n+"|"+typeof r+"]</div>":'<div class="propEditor unknown">[B|'+n+"|"+typeof r+"]</div>"}return"undefined"!=typeof n&&f&&(m+="<!-- /ko -->",m+="<!-- ko ifSubs: { not: true, data: "+b+", threshold: "+w+", gutter: 0 } -->",m+='<span class="label notused">('+n+")</span>",m+="<!-- /ko -->"),m},createBlockEditor=function(e,t,i,r,a,o,n,s,l,d,c,u){"undefined"==typeof c&&(c=!0);var v,f=modelDef.getDef(e,o),p=modelDef.getDef(e,a);"undefined"!=typeof p._previewBindings&&"thaeme"!=o&&"styler"==n&&(v=elaborateDeclarations(void 0,p._previewBindings,r,modelDef.getBindValue.bind(void 0,e,i,a,a,"")));var g,h="undefined"!=typeof d&&d?e[o]._globalStyles:void 0,m="undefined"!=typeof d&&d?e[o]._globalStyle:void 0;if("undefined"!=typeof m){var b=modelDef.getDef(e,"theme");g=b[m.replace(/^(\$theme|_theme_)\./,"")]}var y=modelDef.getBindValue.bind(void 0,e,i,a,o);y._templateName=o;var w='<div class="editor">';w+='<div class="blockType'+("undefined"!=typeof h?" withdefaults":"")+'">'+f.type+"</div>";var k=_propEditor(y,t,r,f,g,"",void 0,n,u,l,h,m,c,v);k.length>0&&(w+=k),w+="</div>",s(w,o,n)},createBlockEditors=function(e,t,i,r,a,o,n,s){createBlockEditor(e,t,i,r,a,o,"edit",n,s),createBlockEditor(e,t,i,r,a,o,"styler",n,s,!0)},generateEditors=function(e,t,i,r,a){var l,o=e._defs,n=e.templateName,s=e._blocks,d=[];for(l=0;l<s.length;l++)"undefined"!=typeof s[l].container&&d.push(modelDef.generateModel(o,s[l].block)),createBlockEditors(o,t,void 0,i,s[l].root,s[l].block,r,a);return"undefined"!=typeof o.theme&&createBlockEditor(o,t,void 0,i,n,"theme","styler",r,void 0,!1,!1,-1),d};module.exports=generateEditors;