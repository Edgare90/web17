"use strict";var converterUtils=require("./utils.js"),cssParse=require("mensch/lib/parser.js"),console=require("console"),domutils=require("./domutils.js"),_declarationValueLookup=function(e,t,i){for(var r=e.length-1;r>=0;r--)if("property"==e[r].type&&e[r].name==t)return _declarationValueUrlPrefixer(e[r].value,i);return null},_propToCamelCase=function(e){return e.replace(/-([a-z])/g,function(e,t,i,r){return t.toUpperCase()})},_declarationValueUrlPrefixer=function(e,t){if(e.match(/url\(.*\)/)){var i=e.replace(/(url\()([^\)]*)(\))/g,function(e,i,r,a){var o=r.trim(),n=r.trim().charAt(0);"'"==n||'"'==n?o=o.substr(1,o.length-2):n="";var s=t(o);return null!==s?i+n+s+n+a:e});return i}return e},elaborateDeclarations=function(e,t,i,r,a,o,n){var s="object"==typeof o&&null!==o?o:{},l=null,d=0;if("undefined"==typeof t){var c=cssParse("#{\n"+e+"}",{comments:!0,position:!0});t=c.stylesheet.rules[0].declarations,d=1}for(var u=t.length-1;u>=0;u--)if("property"==t[u].type)if(n===!0&&"display"==t[u].name&&"none"==t[u].value)null===l&&(l=e),l=converterUtils.removeStyle(l,t[u].position.start,t[u].position.end,d,0,0,"");else{var f=t[u].name.match(/^-ko-(bind-|attr-)?([a-z0-9-]*?)(-if|-ifnot)?$/);if(null!==f){null===l&&"undefined"!=typeof e&&(l=e);var g,b,y,p="attr-"==f[1],v="bind-"==f[1],h=f[2],m="-if"==f[3]||"-ifnot"==f[3];if(m){g=t[u].name.substr(0,t[u].name.length-f[3].length);var w=_declarationValueLookup(t,g,i);if(null===w)throw"Unable to find declaration "+g+" for "+t[u].name}else{if((p||v)&&"undefined"==typeof a&&"undefined"!=typeof e)throw"Attributes and bind declarations are only allowed in inline styles!";var x,k=!0;if(p?(y=domutils.getAttribute(a,h),k=!1,x="virtualAttr"):v?(x=null,"text"==h?"undefined"!=typeof a?y=domutils.getInnerText(a):k=!1:"html"==h&&"undefined"!=typeof a?y=domutils.getInnerHtml(a):k=!1):(k="undefined"!=typeof e,k&&(y=_declarationValueLookup(t,h,i)),x="virtualStyle"),k&&null===y)throw console.error("Cannot find default value for",t[u].name,t),"Cannot find default value for "+t[u].name+": "+t[u].value+" in "+a+" ("+typeof e+"/"+h+")";var C=y,S=v||p?-1!=h.indexOf("-")?"'"+h+"'":h:_propToCamelCase(h);try{b=converterUtils.expressionBinding(t[u].value,r,C)}catch(_){throw console.error("Model ensure path failed",_.stack,"name",t[u].name,"value",t[u].value,"default",y,"element",a),_}null!==x&&"undefined"==typeof s[x]&&(s[x]={}),"virtualAttr"==x&&"href"==S&&(x=null,S="wysiwygHref","undefined"!=typeof a&&null!==a&&domutils.removeAttribute(a,"href"));var $=_declarationValueLookup(t,t[u].name+"-if",i),E=!1;if(null===$)$=_declarationValueLookup(t,t[u].name+"-ifnot",i),E=!0;else if(null!==_declarationValueLookup(t,t[u].name+"-ifnot",i))throw"Unexpected error: cannot use both -if and -ifnot property conditions";if(null!==$)try{var D=converterUtils.conditionBinding($,r);b=(E?"!":"")+"("+D+") ? "+b+" : null"}catch(_){throw console.error("Unable to deal with -ko style binding condition",$,t[u].name),_}null!==x?s[x][S]=b:s[S]=b}if(null!==l)try{if("undefined"!=typeof a&&null!==a)l=converterUtils.removeStyle(l,t[u].position.start,t[u].position.end,d,0,0,"");else{var T="";m||(T=h+": <!-- ko text: "+b+" -->"+y+"<!-- /ko -->"),l=converterUtils.removeStyle(l,t[u].position.start,t[u].position.end,d,0,0,T)}}catch(_){throw console.warn("Remove style failed",_,"name",t[u]),_}}else{var F=_declarationValueUrlPrefixer(t[u].value,i);if(F!=t[u].value&&(null===l&&"undefined"!=typeof e&&(l=e),null!==l))try{l=converterUtils.removeStyle(l,t[u].position.start,t[u].position.end,d,0,0,t[u].name+": "+F)}catch(_){throw console.log("Remove style failed replacing url",_,"name",t[u]),_}var M=_propToCamelCase(t[u].name),O="virtualAttrStyle",j="undefined"!=typeof s.virtualStyle?s.virtualStyle[M]:void 0,A=" ";"undefined"==typeof s[O]&&(s[O]="''",A=""),"undefined"!=typeof j?(s[O]="'"+t[u].name+": '+("+j+")+';"+A+"'+"+s[O],delete s.virtualStyle[M]):s[O]="'"+t[u].name+": "+converterUtils.addSlashes(F)+";"+A+"'+"+s[O]}}if("undefined"!=typeof a&&null!==a){for(var I in s.virtualStyle)if(s.virtualStyle.hasOwnProperty(I))throw console.log("Unexpected virtualStyle binding after conversion to virtualAttr.style",I,s.virtualStyle[I],e),"Unexpected virtualStyle binding after conversion to virtualAttr.style for "+I;delete s.virtualStyle;var P=domutils.getAttribute(a,"data-bind"),z=(null!==P?P+", ":"")+_bindingSerializer(s);domutils.setAttribute(a,"data-bind",z)}if("undefined"==typeof e){var L=!1;for(var H in s.virtualStyle)if(s.virtualStyle.hasOwnProperty(H)){L=!0;break}if(L){if("undefined"!=typeof s.virtualAttrStyle){var B=s.virtualAttrStyle;delete s.virtualAttrStyle,s.virtualAttrStyle=B}}else delete s.virtualStyle;return _bindingSerializer(s)}return l},_bindingSerializer=function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&("object"==typeof e[i]?t.push(i+": { "+_bindingSerializer(e[i])+" }"):t.push(i+": "+e[i]));return t.reverse().join(", ")};module.exports=elaborateDeclarations;