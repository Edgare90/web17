"use strict";function conditional_replace(e){return e.replace(/<!--\[if ([^\]]*)\]>((?:(?!--)[\s\S])*?)<!\[endif\]-->/g,function(e,t,i){var r="<!-- cc:start -->";r+=i.replace(/<([A-Za-z:]+)/g,"<!-- cc:bo:$1 --><cc").replace(/<\/([A-Za-z:]+)>/g,"<!-- cc:bc:$1 --></cc><!-- cc:ac:$1 -->").replace(/\/>/g,"/><!-- cc:sc -->"),r+="<!-- cc:end -->";var a='<replacedcc condition="'+t+'" style="display: none">';return a+=$("<div>").append($(r)).html().replace(/^<!-- cc:start -->/,"").replace(/<!-- cc:end -->$/,""),a+="</replacedcc>"})}var $=require("jquery"),console=require("console"),converterUtils=require("./utils.js"),elaborateDeclarations=require("./declarations.js"),processStylesheetRules=require("./stylesheet.js"),modelDef=require("./model.js"),domutils=require("./domutils.js"),wrapElementWithCondition=function(e,t,i){var r=domutils.getAttribute(t,e);try{var a=converterUtils.conditionBinding(r,i);$(t).before("<!-- ko if: "+a+" -->"),$(t).after("<!-- /ko -->"),domutils.removeAttribute(t,e)}catch(o){throw console.warn("Model ensure path failed in if/variant",t,r,e),o}},replacedAttributes=function(e,t){domutils.setAttribute(e,t,domutils.getAttribute(e,"replaced"+t))},processStyle=function(e,t,i,r){var n,a=domutils.getAttribute(e,"replacedstyle"),o=null;r&&(n={uniqueId:"$data",attr:{id:"id"}});var s=null!==domutils.getAttribute(e,"data-ko-display");o=elaborateDeclarations(a,void 0,t,i,e,n,s),null===o?o=a:domutils.removeAttribute(e,"replacedstyle"),null!==o&&(o.trim().length>0?domutils.setAttribute(e,"style",o):domutils.removeAttribute(e,"style"))},_fixRelativePath=function(e,t,i,r){var a=domutils.getAttribute(r,e),o=t(a);null!==o&&domutils.setAttribute(r,e,o)},processBlock=function(e,t,i,r,a,o,n,s,l,d){try{var c;if("block"==o)c=domutils.getAttribute(e,"data-ko-block"),domutils.removeAttribute(e,"data-ko-block");else{if("template"!=o)throw"Unexpected context name while processing block: "+o;c=n}$("[data-ko-remove]",e).remove();for(var v=$("[data-ko-block]",e).replaceWith("<replacedblock>"),p=["href","src","data-ko-placeholder-src","background"],h=0;h<p.length;h++){var m=_fixRelativePath.bind(void 0,p[h],a);$("["+p[h]+"]",e).each(m)}var g=domutils.getAttribute(e,"data-ko-properties");null===g&&(g=""),$("[data-ko-properties]",e).each(function(e,t){g.length>0&&(g+=" "),g+=domutils.getAttribute(t,"data-ko-properties"),domutils.removeAttribute(t,"data-ko-properties")}),modelDef.createOrUpdateBlockDef(t,c,g,{contextName:o});var b=modelDef.ensurePathAndGetBindValue.bind(void 0,t,i,n,c,"");"block"==o&&b("id",""),$("style",e).each(function(e,r){var o=domutils.getInnerHtml(r),s=modelDef.createOrUpdateBlockDef.bind(void 0,t),l=modelDef.ensurePathAndGetBindValue.bind(void 0,t,i,n),u=processStylesheetRules(o,void 0,l,s,i,a,n,c);if(u!=o)if(""!==u.trim()){var f=d(u);domutils.setAttribute(r,"data-bind","template: { name: '"+f+"' }"),domutils.setContent(r,"")}else domutils.removeElements($(r))}),processStyle(e,a,b,l);for(var y=["data-ko-display","data-ko-editable","data-ko-wrap","href"],w=0;w<y.length;w++){var k=domutils.getAttribute(e,y[w]);if(k)throw console.warn("ERROR: Unsupported "+y[w]+" used together with data-ko-block",e),"ERROR: Unsupported "+y[w]+" used together with data-ko-block"}return $("[data-ko-link]",e).each(function(e,t){var i=domutils.getAttribute(t,"data-ko-link"),r=domutils.getAttribute(t,"replacedstyle");("undefined"==typeof r||null===r)&&(r=""),r=""!==r?"-ko-attr-href: @"+i+"; "+r:"-ko-attr-href: @"+i,domutils.setAttribute(t,"replacedstyle",r),domutils.setAttribute(t,"data-ko-wrap",i),domutils.removeAttribute(t,"data-ko-link")}),$("[replacedstyle]",e).each(function(e,t){processStyle(t,a,b,!1)}),$("[replacedhttp-equiv]",e).each(function(e,t){replacedAttributes(t,"http-equiv")}),$("[data-ko-display]",e).each(function(e,t){wrapElementWithCondition("data-ko-display",t,b)}),$("[data-ko-editable]",e).each(function(e,t){var i,r,o,n,l,c,s=domutils.getAttribute(t,"data-ko-editable");if(s.lastIndexOf(".")>0){var u=s.substr(0,s.lastIndexOf("."));l=b(u)}else l=b(s);if(c="wysiwygClick: function(obj, evt) { $root.selectItem("+l+", $data); return false }, clickBubble: false, wysiwygCss: { selecteditem: $root.isSelectedItem("+l+") }, scrollIntoView: $root.isSelectedItem("+l+")","img"!=domutils.getLowerTagName(t)){r=domutils.getInnerHtml(t);var f=b(s,r,!0,"wysiwyg");if(i="",domutils.getAttribute(t,"id")||(i+="wysiwygId: id()+'_"+s.replace(".","_")+"', "),"undefined"!=typeof c&&(i+=c+", "),i+="wysiwygOrHtml: "+f,"td"==domutils.getLowerTagName(t)){var v=$('<div data-ko-wrap="false" style="width: 100%; height: 100%"></div>')[0];domutils.setAttribute(v,"data-bind",i);var p=domutils.getInnerHtml($("<div></div>").append(v));domutils.setContent(t,p)}else o=domutils.getAttribute(t,"data-bind"),n=(null!==o?o+", ":"")+i,domutils.setAttribute(t,"data-bind",n),domutils.setContent(t,"");domutils.removeAttribute(t,"data-ko-editable")}else{var h=domutils.getAttribute(t,"width");if(""===h&&(h=null),null===h)throw console.error("ERROR: data-ko-editable images must declare a WIDTH attribute!",t),"ERROR: data-ko-editable images must declare a WIDTH attribute!";var m=domutils.getAttribute(t,"height");""===m&&(m=null);var g=domutils.getAttribute(t,"align");o=domutils.getAttribute(t,"data-bind");var y=o&&o.match(/virtualAttr: {[^}]* height: ([^,}]*)[,}]/);y&&(m=y[1]);var w=o&&o.match(/virtualAttr: {[^}]* width: ([^,}]*)[,}]/);w&&(h=w[1]);var k;r=domutils.getAttribute(t,"data-ko-placeholder-src");var x="";r?x=domutils.getAttribute(t,"src"):r=domutils.getAttribute(t,"src");var C;h&&m?C=h+"+'x'+"+m:m?h||(C="'h'+"+m+"+''"):C="'w'+"+h+"+''";var S,_=m||domutils.getAttribute(t,"data-ko-placeholder-height"),E=h||domutils.getAttribute(t,"data-ko-placeholder-width");if(domutils.removeAttribute(t,"src"),domutils.removeAttribute(t,"data-ko-editable"),domutils.removeAttribute(t,"data-ko-placeholder-height"),domutils.removeAttribute(t,"data-ko-placeholder-width"),domutils.removeAttribute(t,"data-ko-placeholder-src"),r&&(S="{ width: "+E+", height: "+_+", text: "+C+"}"),!E||!_)throw console.error("IMG data-ko-editable must declare width and height attributes, or their placeholder counterparts data-ko-placeholder-width/data-ko-placeholder-height",t),"ERROR: IMG data-ko-editable MUST declare width and height attributes, or their placeholder counterparts data-ko-placeholder-width/data-ko-placeholder-height";var T=b(s,x,!1,"wysiwyg");i="wysiwygSrc: { width: "+h+", height: "+m+", src: "+T+", placeholder: "+S+" }",n=(null!==o?o+", ":"")+i,domutils.setAttribute(t,"data-bind",n);var D=d(t),F="{ width: "+h;"left"==g?F+=", float: 'left'":"right"==g?F+=", float: 'right'":"center"==g?console.log("non so cosa fa align=center su una img e quindi non so come simularne l'editing"):"top"==g?F+=", verticalAlign: 'top'":"middle"==g?F+=", verticalAlign: 'middle'":"bottom"==g&&(F+=", verticalAlign: 'bottom'"),F+="}",$(t).before("<!-- ko wysiwygImg: { _data: $data, _item: "+l+", _template: '"+D+"', _editTemplate: 'img-wysiwyg', _src: "+T+", _width: "+h+", _height: "+m+", _align: "+(null===g?void 0:"'"+g+"'")+", _size: "+C+", _method: "+k+", _placeholdersrc: "+S+", _stylebind: "+F+" } -->"),$(t).after("<!-- /ko -->")}}),$("[href]",e).each(function(e,t){var i=domutils.getAttribute(t,"href"),r="wysiwygHref: '"+converterUtils.addSlashes(i)+"'",a=domutils.getAttribute(t,"data-bind"),o=(null!==a?a+", ":"")+r;domutils.setAttribute(t,"data-bind",o)}),$("replacedblock",e).each(function(e,o){var l=v[e],u=processBlock(l,t,i,r,a,"block",c,s,!0,d),f=modelDef.ensurePathAndGetBindValue(t,i,n,c,"",u);$(o).before("<!-- ko block: { data: "+converterUtils.addSlashes(f)+", template: 'block' } -->"),$(o).after("<!-- /ko -->"),$(o).remove()}),$($("[data-ko-wrap]",e).get().reverse(),e).each(function(e,t){var i=domutils.getAttribute(t,"data-ko-wrap");if("undefined"==typeof i||""===i||"true"===i)throw"Unsupported empty value for data-ko-wrap: use false value if you want to always remove the tag";var o,n,r=converterUtils.conditionBinding(i,b),a=domutils.getAttribute(t,"data-bind");if(""!==a&&null!==a&&a.match(/(block|wysiwygOrHtml):/)){var s="<!-- ko "+a+" -->"+domutils.getInnerHtml(t)+"<!-- /ko -->";o=d(s),domutils.removeAttribute(t,"data-ko-wrap"),n=d(t),domutils.replaceHtml(t,"<!-- ko template: /* special */ (typeof templateMode != 'undefined' && templateMode == 'wysiwyg') || "+r+" ? '"+n+"' : '"+o+"' --><!-- /ko -->")}else o=d(domutils.getInnerHtml(t)),domutils.removeAttribute(t,"data-ko-wrap"),domutils.setContent(t,"<!-- ko template: '"+o+"' --><!-- /ko -->"),n=d(t),domutils.replaceHtml(t,"<!-- ko template: (typeof templateMode != 'undefined' && templateMode == 'wysiwyg') || "+r+" ? '"+n+"' : '"+o+"' --><!-- /ko -->")}),d(e,c,"show"),r(n,c,o,s),c}catch(x){throw console.error("Exception while parsing the template",x,e),x}},translateTemplate=function(e,t,i,r){var a={},o=conditional_replace(t.replace(/(<[^>]+\s)(style|http-equiv)(="[^"]*"[^>]*>)/gi,function(e,t,i,r){return t+"replaced"+i+r})),n=$(o),s=n[0],l=[],d=function(e,t,i,r){l.push({root:e,block:t,context:i,container:r})},c=function(e,t,i){if("undefined"==typeof a.themes&&(a.themes={}),"undefined"==typeof a.themes[e]&&(a.themes[e]={}),"undefined"==typeof a.themes[e][t]||null===a.themes[e][t])a.themes[e][t]=i;else if("undefined"!=typeof i&&null!==i){var r=a.themes[e][t];r!=i&&console.log("Error setting a new default for property "+t+" in theme "+e+". old:"+r+" new:"+i+"!")}},u=$("[data-ko-container]",n),f={};u.each(function(e,t){var i=domutils.getAttribute(t,"data-ko-container")+"Blocks";domutils.removeAttribute(t,"data-ko-container"),domutils.setAttribute(t,"data-bind","block: "+i);var r=$("> [data-ko-block]",t);domutils.removeElements(r,!0),f[i]=r}),modelDef.createOrUpdateBlockDef(a,"id"),modelDef.createOrUpdateBlockDef(a,"bodyTheme"),modelDef.createOrUpdateBlockDef(a,"blocks","blocks[]"),modelDef.createOrUpdateBlockDef(a,"text"),processBlock(s,a,c,d,i,"template",e,void 0,!1,r);var v=function(t,o,n){processBlock(n,a,c,d,i,"block",e,t,!0,r)};for(var p in f)if(f.hasOwnProperty(p)){var h=f[p],m=p;modelDef.ensurePathAndGetBindValue(a,c,e,e,"",m+".blocks","[]"),h.each(v.bind(void 0,m))}var g={_defs:a,templateName:e,_blocks:l};return"undefined"!=typeof a[e]._version&&(g.version=a[e]._version),g};module.exports=translateTemplate;