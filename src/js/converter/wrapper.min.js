"use strict";var ko=require("knockout"),kowrap=require("knockout.wrap"),console=require("console"),_getOptionsObject=function(e){for(var t=e.split("|"),i={},r=0;r<t.length;r++){var a=t[r].split("=");i[a[0]]=a.length>1?a[1]:a[0]}return i},_makeComputed=function(e,t,i,r,a,n){var o=ko.computed({read:function(){var i=e();if(null===i){var o=ko.utils.unwrapObservable(r);return"undefined"==typeof o||"custom"==o?ko.utils.unwrapObservable(t):n[o][a]}return i},write:function(o){var l,s=ko.utils.unwrapObservable(r);if(l="undefined"==typeof s||"custom"==s?ko.utils.peekObservable(t):n[s][a],i)e(o==l?null:o);else{var d=ko.utils.peekObservable(e);(o!=l||null!==d)&&e(o)}}});return o},_nextVariantFunction=function(e,t,i){for(var a,r=e.utils.unwrapObservable(t),n=0;n<i.length&&(a=e.utils.peekObservable(i[n]),a!=r);n++);n==i.length&&(console.warn("Didn't find a variant!",t,r,i),n=i.length-1);var o=n+1;o==i.length&&(o=0);var s=e.utils.peekObservable(i[o]);t(s)},_getVariants=function(e){var i,t=e._variant;if("object"!=typeof e[t]||"undefined"==typeof e[t]._widget||"string"!=typeof e[t]._options&&"boolean"!==e[t]._widget)throw console.error("Unexpected variant declaration",t,e[t]),"Unexpected variant declaration: cannot find property "+t+" or its _options string and it is not a boolean";return i="string"==typeof e[t]._options?Object.keys(_getOptionsObject(e[t]._options)):[!0,!1]},_makeComputedFunction=function(e,t,i,r,a,n,o){if("undefined"==typeof e){if("undefined"==typeof r.utils.unwrapObservable(o).type)throw console.log("TODO ERROR Found a non-typed def ",e,o),"Found a non-typed def "+e;var s=r.utils.unwrapObservable(r.utils.unwrapObservable(o).type);e=t[s],"object"!=typeof e&&console.log("TODO ERROR Found a non-object def ",e,"for",s)}"undefined"==typeof a&&"undefined"!=typeof n&&n&&(a=o);var l="$root.content().",d=e._globalStyles;if("undefined"!=typeof d)for(var c in d)if(d.hasOwnProperty(c)){var f,v,p,u="$root.content().theme().scheme";if(d[c].substr(0,l.length)!=l)throw"UNEXPECTED globalStyle path ("+d[c]+") outside selfPath ("+l+")";p=d[c].substr(l.length),v=a,u.substr(0,l.length)==l?f=u.substr(l.length):(console.log("IS THIS CORRECT?",u,l),f=u);for(var h=v,m=p.split("()."),g="",b=!0,y=0;y<m.length;y++)v=r.utils.unwrapObservable(v)[m[y]],b?"theme"==m[y]&&(b=!1):(g.length>0&&(g+="."),g+=m[y]);for(var w=f.split("()."),k=0;k<w.length;k++)h=r.utils.unwrapObservable(h)[w[k]];for(var x=!0,C=c.split("."),S=o,_=0;_<C.length;_++)S=r.utils.unwrapObservable(S)[C[_]];if(!r.isObservable(S))throw"Unexpected non observable target "+c+"/"+g;S._defaultComputed=_makeComputed(S,v,x,h,g,i)}if("undefined"!=typeof e._variant){for(var E=e._variant.split("."),$=o,T=r.utils.unwrapObservable(o),D=0;D<E.length;D++)$=r.utils.unwrapObservable($)[E[D]];if("undefined"!=typeof $._defaultComputed&&(console.log("Found variant on a style property: beware variants should be only used on content properties because they don't match the theme fallback behaviour",e._variant),$=$._defaultComputed),"undefined"==typeof $)throw console.log("ERROR looking for variant target",e._variant,o),"ERROR looking for variant target "+e._variant;T._nextVariant=_nextVariantFunction.bind($,r,$,_getVariants(e))}for(var F in e)if(e.hasOwnProperty(F)){var M=e[F];if("object"==typeof M&&null!==M&&"undefined"!=typeof M._context&&"block"==M._context){var O=a[F](),j=_makeComputedFunction(t[F],t,i,r,a,n,O);o[F](j)}else if("object"==typeof M&&null!==M&&"blocks"==M.type){for(var z,A,L,I=a[F](),P=I.blocks(),H=0;H<P.length;H++)z=r.utils.unwrapObservable(P[H]),A=r.utils.unwrapObservable(z.type),L=_makeComputedFunction(t[A],t,i,r,a,n,z),P[H](L);var q=I.blocks;_augmentBlocksObservable(q,_blockInstrumentFunction.bind(I,void 0,t,i,r,void 0,a,n)),a[F]._wrap=_makeBlocksWrap.bind(a[F],q._instrumentBlock),a[F]._unwrap=_unwrap.bind(a[F])}}return o},_augmentBlocksObservable=function(e,t){e._instrumentBlock=t,"undefined"==typeof e.origPush&&(e.origPush=e.push,e.push=_makePush.bind(e),e.origSplice=e.splice,e.splice=_makeSplice.bind(e))},_makeBlocksWrap=function(e,t){var i=ko.toJS(t),r=i.blocks;i.blocks=[];var a=kowrap.fromJS(i,void 0,!0)();_augmentBlocksObservable(a.blocks,e);for(var n=0;n<r.length;n++){var o=ko.toJS(r[n]);o.id="block_"+n,a.blocks.push(o)}this(a)},_makePush=function(){if(arguments.length>1)throw"Array push with multiple arguments not implemented";if(arguments.length>0&&ko.isObservable(arguments[0])&&("function"==typeof arguments[0]._unwrap?arguments[0]=arguments[0]._unwrap():console.log("WARN: pushing observable with no _unwrap function (TODO remove me, expected condition)")),ko.isObservable(arguments[0]))return this.origPush.apply(this,arguments);var e=this._instrumentBlock(arguments[0]);return this.origPush.apply(this,[e])},_makeSplice=function(){if(arguments.length>3)throw"Array splice with multiple objects not implemented";if(arguments.length>2&&ko.isObservable(arguments[2])&&("function"==typeof arguments[2]._unwrap?arguments[2]=arguments[2]._unwrap():console.log("WARN: splicing observable with no _unwrap function (TODO remove me, expected condition)")),arguments.length>2&&!ko.isObservable(arguments[2])){var e=this._instrumentBlock(arguments[2]);return this.origSplice.apply(this,[arguments[0],arguments[1],e])}return this.origSplice.apply(this,arguments)},_blockInstrumentFunction=function(e,t,i,r,a,n,o,s){"undefined"==typeof a&&(a=s);var l;l={"":_makeComputedFunction.bind(a,e,t,i,r,n,o)};var d=kowrap.fromJS(a,l,!0);return d._unwrap=_unwrap.bind(d),d},_wrap=function(e,t){var i=ko.utils.unwrapObservable(e(ko,t,void 0,!0));this(i)},_unwrap=function(){return ko.toJS(this)},_modelInstrument=function(e,t,i){var r=_blockInstrumentFunction.bind(void 0,t,i,i.themes),a=r(ko,e,void 0,!0);return a._wrap=_wrap.bind(a,r),a._unwrap=_unwrap.bind(a),a};module.exports=_modelInstrument;