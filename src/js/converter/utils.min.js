"use strict";var console=require("console"),jsep=require("jsep");jsep.addBinaryOp("or",1),jsep.addBinaryOp("and",2),jsep.addBinaryOp("eq",6),jsep.addBinaryOp("neq",6),jsep.addBinaryOp("lt",7),jsep.addBinaryOp("lte",7),jsep.addBinaryOp("gt",7),jsep.addBinaryOp("gte",7);var addSlashes=function(e){return e.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},removeStyle=function(e,t,i,r,a,o,n){for(var s=e.split("\n"),l=a,d=o,c=1+r;c<t.line;c++)l+=s[c-1-r].length+1;if(l+=t.col,null!==i){for(var u=1+r;u<i.line;u++)d+=s[u-1-r].length+1;d+=i.col}else d+=e.length+1;var f=e.substr(0,l-1)+n+e.substr(d-1);return f},expressionGenerator=function(e,t,i){function r(e){switch(e){case"or":return"||";case"and":return"&&";case"lt":return"<";case"lte":return"<=";case"gt":return">";case"gte":return">=";case"eq":return"==";case"neq":return"!=";default:return e}}function a(e,t,i,o){if("undefined"==typeof i&&(i=!0),"undefined"!=typeof o&&"Identifier"!==e.type&&"MemberExpression"!==e.type&&console.log("Cannot apply default value to variable when using expressions"),"BinaryExpression"===e.type||"LogicalExpression"===e.type)return"("+a(e.left,t,i)+" "+r(e.operator)+" "+a(e.right,t,i)+")";if("CallExpression"===e.type){var n=e.arguments.map(function(e){return a(e,t,i)});return a(e.callee,t,i)+"("+n.join(", ")+")"}if("UnaryExpression"===e.type)return e.operator+a(e.argument,t,i);if("MemberExpression"==e.type&&e.computed)throw"Unexpected computed member expression";if("MemberExpression"!=e.type||e.computed){if("Literal"===e.type)return e.raw;if("Identifier"===e.type){var l=e.name;return i?t(l,o)+"()":l}if("ConditionalExpression"===e.type)return"("+a(e.test,t,i)+" ? "+a(e.consequent,t,i)+" : "+a(e.alternate,t,i)+")";throw"Compound"===e.type?"Syntax error in expression: operator expected after "+a(e.body[0],t,!1):"Found an unsupported expression type: "+e.type}var s=a(e.object,t,!1)+"."+a(e.property,t,!1);return i&&"Math"!==e.object.name&&"Color"!==e.object.name?t(s,o)+"()":s}return a(e,t,void 0,i)},expressionBinding=function(e,t,i){var r;if("undefined"!=typeof i&&null!==i){var a=e.trim().replace(/@\[([^\]]+)\]|@([a-zA-Z0-9\._]+)\b/g,"###var###");if(a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"###var###"==a)r=[null,i];else if(a="^"+a.replace(/###var###/g,"(.+)")+"$",r=i.trim().match(new RegExp(a)),!r)throw console.log("Cannot find matches",r,"for",i,e,a,e),"Cannot find default value for "+e+" in "+i}try{var o=0,n="'"+e.replace(/@\[([^\]]+)\]|@([a-zA-Z0-9\._]+)\b|(')/g,function(e,i,a,n){if(n)return"\\"+n;o++;var l,s=i||a;if(r&&("undefined"!=typeof r[o]?l=r[o].trim():console.log("ABZZZ Cannot find default value for",s,"in",r,"as",o)),i){var d=jsep(i),c=expressionGenerator(d,t,l);return"'+"+c+"+'"}return"'+"+t(s,l)+"()+'"})+"'";return n=n.replace(/(^|[^\\])''\+/g,"$1").replace(/\+''/g,""),0===o&&"false"!==n&&"true"!==n&&console.error("Unexpected expression with no valid @variable references",e),n}catch(s){throw"Exception parsing expression "+e+" "+s}},conditionBinding=function(e,t){var i=jsep(e),r=expressionGenerator(i,t);return r};module.exports={addSlashes:addSlashes,removeStyle:removeStyle,conditionBinding:conditionBinding,expressionBinding:expressionBinding};