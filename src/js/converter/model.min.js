"use strict";var objExtend=require("./domutils.js").objExtend,console=require("console"),_valueSet=function(e,t,i,r){var a=i.indexOf(".");if(-1==a)if("undefined"==typeof t[i])console.log("Undefined prop "+i+" while setting value "+r+" in model._valueSet");else if(null===t[i])"object"==typeof r&&null!==r&&"undefined"==typeof r.push&&console.log("nullpropobjectvalue",i,r),t[i]=r;else if("object"==typeof t[i]&&"function"==typeof t[i].push){var o;if("string"==typeof r){var n=r.match(/^\[(.*)\]$/);if(null===n)throw"Unexpected default value for array property "+i+": "+r;o=n[1].split(",")}else{if("object"!=typeof r||"undefined"==typeof r.push)throw"Unexpected default value for array property "+i+": "+r+" typeof "+typeof r;o=r}for(var s=[],l=0;l<o.length;l++)"@"==o[l].substr(0,1)?s.push(_generateModel(e,o[l].substr(1))):o[l].length>0&&s.push(o[l]);t[i]=s}else"string"==typeof t[i]||"boolean"==typeof t[i]?t[i]=r:"object"==typeof t[i]&&null!==t[i]&&"undefined"!=typeof t[i]._widget?("object"==typeof r&&null!==r&&console.log("objectvalue",i,t[i]._widget,r),t[i]=r):console.log("setting",typeof t[i],t[i],i,r);else{var d=i.substr(0,a);_valueSet(e,t[d],i.substr(a+1),r)}},_modelCreateOrUpdateBlockDef=function(e,t,i,r){if("undefined"!=typeof e[t]&&e[t]._initialized&&!e[t]._writeable)throw console.log("_modelCreateOrUpdateBlockDef",e,t,i,r),"Trying to alter non writeable model: "+t+" / "+i;if("undefined"==typeof e[t]&&(e[t]={_writeable:!0},"undefined"==typeof r&&(r={}),"undefined"==typeof r.category&&"undefined"==typeof e[t]._category&&(t.match(/(^t|.T)heme$/)||t.match(/(^s|.S)tyle$/)||t.match(/(^c|.C)olor$/)||t.match(/(^r|.R)adius$/)?r.category="style":r.category="content")),"undefined"!=typeof r){if("undefined"!=typeof r.name&&(e[t]._name=r.name),"undefined"!=typeof r.themeOverride&&(e[t]._themeOverride=r.themeOverride),"undefined"!=typeof r.globalStyle){e[t]._globalStyle=r.globalStyle;var a=r.globalStyle.replace(/^(\$theme|_theme_)\./,""),o=a.indexOf("."),n=-1!=o?a.substr(0,o):a;_modelCreateOrUpdateBlockDef(e,"theme",n),("undefined"==typeof e[t]._themeOverride||e[t]._themeOverride)&&_modelCreateOrUpdateBlockDef(e,t,"customStyle=false")}"undefined"!=typeof r.contextName&&(e[t]._context=r.contextName,"block"==r.contextName&&"undefined"==typeof e[t]._globalStyle&&(e[t]._globalStyle="_theme_.bodyTheme",_modelCreateOrUpdateBlockDef(e,"theme","bodyTheme"),("undefined"==typeof e[t]._themeOverride||e[t]._themeOverride)&&_modelCreateOrUpdateBlockDef(e,t,"customStyle=false"))),"undefined"!=typeof r.extend&&(e[t].type=r.extend)}for(var s in r)r.hasOwnProperty(s)&&"undefined"!=typeof r[s]&&-1==["name","extend","contextName","globalStyle","themeOverride"].indexOf(s)&&(e[t]["_"+s]=r[s]);"undefined"!=typeof i&&i.length>0&&(e[t]._props="undefined"!=typeof e[t]._props&&e[t]._props.length>0?e[t]._props+" "+i:i)},_removePrefix=function(e){var t=e.match(/^[^A-Z]+([A-Z])(.*)$/);return null!==t?t[1].toLowerCase()+t[2]:null},_generateModelFromDef=function(e,t){var i={};for(var r in e)if(!r.match(/^_.*/)&&e.hasOwnProperty(r)){var a=e[r];if("object"==typeof a&&null!==a&&"undefined"!=typeof a._complex&&a._complex)i[r]=_generateModelFromDef(a,t);else if("type"==r)i[r]=a;else{if("object"!=typeof a)throw console.error("Unexpected model def",r,a,e),"Unexpected model def ["+r+"]="+a;i[r]=null}}if("undefined"!=typeof e._defaultValues){var o=e._defaultValues;for(var n in o)o.hasOwnProperty(n)&&_valueSet(t,i,n,o[n])}return i},_generateModel=function(e,t){var i=_getModelDef(e,t,!1,!0);return _generateModelFromDef(i,e)},_getDef=function(e,t){return _getModelDef(e,t,!1,!0)},_getModelDef=function(e,t,i,r){if("undefined"==typeof e[t]){if(-1!=t.indexOf(" "))return null;var a=_removePrefix(t);return null!==a?_getModelDef(e,a,i,r):null}var o=e[t];if("object"!=typeof o)throw"Block definition must be an object: found "+o+" for "+t;if("undefined"==typeof o._initialized){if("undefined"==typeof o.type&&(-1==t.indexOf(" ")?o.type=t:o.type=t.substr(t.indexOf(" ")+1)),o.type!=t&&"undefined"==typeof o._widget){var n=_getModelDef(e,o.type,!0),s=objExtend(n,o);o=s,e[t]=o}else"undefined"==typeof o._widget&&"undefined"==typeof o._props&&"undefined"==typeof o._complex;o._writeable=!0,o._initialized=!0}if("undefined"!=typeof o._props){var l=o._props;if(l=l.split(" "),l.length>0&&"undefined"==typeof o._writeable)throw console.error("Altering a non writable object ",t,l,o),"Altering a non writable object: "+t+" def: "+l;"undefined"==typeof o._processedDefs&&(o._processedDefs={}),"undefined"==typeof o._globalStyles&&(o._globalStyles={}),"undefined"==typeof o._defaultValues&&(o._defaultValues={});for(var d=0;d<l.length;d++){var c=l[d];if(0!==c.length){var u=c,f=null,v=c.match(/^([^=\[\]]+)(\[\])?(=?)(.*)$/);if(null!==v&&(c=v[1],"[]"==v[2]&&("undefined"==typeof o[c]&&(o[c]=[]),f=[]),"="==v[3]&&(f=c.match(/(^v|V)isible$/)?"true"==String(v[4]).toLowerCase():c.match(/^customStyle$/)?"true"==String(v[4]).toLowerCase():v[4])),null!==f&&"undefined"==typeof o._defaultValues[c]&&(o._defaultValues[c]=f),"undefined"==typeof o[c]){var p=_getModelDef(e,t+" "+c,!0);null===p&&(p=_getModelDef(e,c,!0)),o[c]=p}o._processedDefs[c]=u,o._complex=!0}}delete o._props}if(i){o._writeable=!1;var h=objExtend({},o);return h}if(r)return o._writeable=!1,o;if("undefined"==typeof o._writeable||o._writeable===!1)throw"Retrieving non writeable object definition: "+t;return o},_increaseUseCount=function(e,t){if(e){if("undefined"==typeof t._usecount)throw console.error("ERROR trying to bind an unused property while readonly",t),"ERROR trying to bind an unused property"}else"undefined"==typeof t._usecount&&(t._usecount=0),t._usecount++},ensureGlobalStyle=function(e,t,i,r,a,o,n,s){var l=i(o,n,s);if("undefined"==typeof e[r]._globalStyles[a]){if(t)throw"Cannot find _globalStyle for "+a+" in "+r+"!";(-1!=a.indexOf(".")||"object"==typeof e[r][a]&&"undefined"!=typeof e[r][a]._widget)&&(e[r]._globalStyles[a]=l)}else if(e[r]._globalStyles[a]!=l)throw"Unexpected conflicting globalStyle [2] for "+r+"/"+a+": old="+e[r]._globalStyles[a]+" new="+l},modelEnsurePathAndGetBindValue=function(e,t,i,r,a,o,n,s,l,d){var c,u,f;if("$"==n.substr(0,1)){console.warn("DEPRECATED $ in bindingProvider: ",n,a);var v=n.indexOf(".");if(-1==v)throw"Unexpected fullPath: "+n+"/"+o+"/"+a+"/"+s+"/"+l;if(c=n.substr(1,v-1),f=n.substr(v+1),"theme"!=c)throw"Unexpected $ sequence: "+c+" in "+n;var p=f.indexOf(".");c=f.substr(0,p),f=f.substr(p+1),u="$root.content().theme()."+c+"()."+f.replace(new RegExp("\\.","g"),"().")}else if("#"==n.substr(0,1))console.warn("DEPRECATED # in bindingProvider: ",n,a),c=r,f=n.substr(1),u="$root.content()."+f.replace(new RegExp("\\.","g"),"().");else if("_theme_."==n.substr(0,8)){var h=n.indexOf(".",8);c=n.substr(8,h-8),f=n.substr(h+1),u="$root.content().theme()."+c+"()."+f.replace(new RegExp("\\.","g"),"().")}else"_root_."==n.substr(0,7)?(c=r,f=n.substr(7),u="$root.content()."+f.replace(new RegExp("\\.","g"),"().")):(c=a,f=o+n,u=n.replace(new RegExp("\\.","g"),"()."));if("undefined"==typeof t[c])throw"Cannot find model def for ["+c+"]";var m=f.indexOf("."),g=-1==m?f:f.substr(0,m);if(-1!=c.indexOf("-"))throw console.error("ERROR cannot use - for block names",c),"ERROR unexpected char in block name: "+c;if(-1!=g.indexOf("-"))throw console.error("ERROR cannot use - for property names",g),"ERROR unexpected char in property name: "+c;if(e)return"undefined"!=typeof t[c]._globalStyle&&"undefined"!=typeof t[c][g]&&"style"==t[c][g]._category&&(u+="._defaultComputed"),u;var b;if(e){if("undefined"!=typeof s)throw"Cannot use defaultValue in readonly mode!";if(l)throw"Cannot use overrideDefault in readonly mode for "+c+"/"+f+"/"+l+"!";if("undefined"!=typeof d)throw"Cannot set category for "+c+"/"+f+"/"+d+" in readonly mode!";b=_getModelDef(t,c,!1,!0)}else t[c]._writeable===!1&&console.log("TODO debug use cases for this condition",c,f),b=_getModelDef(t,c,t[c]._writeable===!1);if(null===b)throw"Unexpected model for ["+c+"]";if("undefined"==typeof b[g]){if(e)throw"Cannot find path "+g+" for "+c+"!";_modelCreateOrUpdateBlockDef(t,c,g),b=_getModelDef(t,c,!1)}"undefined"!=typeof t[c]._globalStyle&&"undefined"!=typeof t[c][g]&&null!==t[c][g]&&"style"==t[c][g]._category&&(u+="._defaultComputed");var y=b;try{if(_increaseUseCount(e,y),-1!=m){var w=f;do{var k=w.substr(0,m);if("undefined"==typeof y[k])throw"Found an unexpected prop "+k+" for model "+c+" for "+f;y=y[k],_increaseUseCount(e,y),w=w.substr(m+1),m=w.indexOf(".")}while(-1!=m);if("undefined"==typeof y[w]||null===y[w])throw"Found an unexpected path termination "+w+" for model "+c+" for "+f;y=y[w]}else y=y[f];if("undefined"==typeof y||null===y)throw"Unexpected null model for "+c+"/"+o+"/"+n;"undefined"!=typeof d&&(y._category=d),_increaseUseCount(e,y)}catch(x){throw console.error("TODO ERROR Property lookup exception",x,c,f,a,n,t),x}if("undefined"!=typeof t[c]._globalStyle&&"object"==typeof t[c][g]&&null!==t[c][g]&&"undefined"!=typeof t[c][g]._category&&"style"==t[c][g]._category){var C=modelEnsurePathAndGetBindValue.bind(void 0,e,t,i,r,a,""),S=-1!=f.indexOf(".")?f.substr(f.indexOf(".")):"";if(-1!=S.indexOf(".",1))throw"TODO unsupported object nesting! "+f;var _=t[c]._globalStyle+"."+g;"object"==typeof t[c][g]&&null!==t[c][g]&&"undefined"!=typeof t[c][g]._globalStyle&&(_=t[c][g]._globalStyle),ensureGlobalStyle(t,e,C,c,g,_,void 0,!1);var $=_+S;if("undefined"==typeof s&&null!==t[c]._defaultValues[f]&&(s=t[c]._defaultValues[f]),ensureGlobalStyle(t,e,C,c,f,$,s,l),"undefined"!=typeof s){if(e)throw console.error("Cannot set a new theme default value",$.substr(7),s,"while in readonly mode"),"Cannot set a new theme default value ("+s+") for "+$.substr(7)+" while in readonly mode!";i("default",$.substr(7),s)}s=null}if("undefined"!=typeof s)if("undefined"==typeof t[c]._defaultValues[f]||"undefined"!=typeof l&&l){if(e)throw"Cannot set new _defaultValues [1] for "+f+" in "+c+"!";t[c]._defaultValues[f]=s}else if(null===s){if(e&&null!==t[c]._defaultValues[f])throw"Cannot set new _defaultValues [2] for "+f+" in "+c+"!";t[c]._defaultValues[f]=null}else if(t[c]._defaultValues[f]!=s)throw console.error("TODO error!!! Trying to set a new default value for "+c+" "+f+" while it already exists (current: "+t[c]._defaultValues[f]+", new: "+s+")"),"Trying to set a new default value for "+c+" "+f+" while it already exists (current: "+t[c].defaultValues[f]+", new: "+s+")";return u},generateResultModel=function(e){var t=e._defs,i=e.templateName,r=_generateModel(t,i);return"undefined"!=typeof t.theme&&(r.theme=_generateModel(t,"theme")),r};module.exports={ensurePathAndGetBindValue:modelEnsurePathAndGetBindValue.bind(void 0,!1),getBindValue:modelEnsurePathAndGetBindValue.bind(void 0,!0),generateModel:_generateModel,generateResultModel:generateResultModel,getDef:_getDef,createOrUpdateBlockDef:_modelCreateOrUpdateBlockDef};