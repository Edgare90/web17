"use strict";function initializeEditor(e,t,i,r){function o(e){return e.replace(/<replacedcc[^>]* condition="([^"]*)"[^>]*>([\s\S]*?)<\/replacedcc>/g,function(e,t,i){var r="<!--[if "+t.replace(/&amp;/,"&")+"]>";return r+=i.replace(/<!-- cc:bc:([A-Za-z:]*) -->(<\/cc>)?<!-- cc:ac:\1 -->/g,"</$1>").replace(/><\/cc><!-- cc:sc -->/g,"/>").replace(/<!-- cc:bo:([A-Za-z:]*) --><cc/g,"<$1").replace(/^.*<!-- cc:start -->/,"").replace(/<!-- cc:end -->.*$/,""),r+="<![endif]-->"})}var a={galleryRecent:ko.observableArray([]).extend({paging:16}),galleryRemote:ko.observableArray([]).extend({paging:16}),selectedBlock:ko.observable(null),selectedItem:ko.observable(null),selectedTool:ko.observable(0),selectedImageTab:ko.observable(0),dragging:ko.observable(!1),draggingImage:ko.observable(!1),galleryLoaded:ko.observable(!1),showPreviewFrame:ko.observable(!1),previewMode:ko.observable("mobile"),showToolbox:ko.observable(!0),showTheme:ko.observable(!1),showGallery:ko.observable(!1),debug:ko.observable(!1),contentListeners:ko.observable(0),logoPath:"dist/img/mosaico32.png",logoUrl:".",logoAlt:"mosaico"};return a.content=e,a.blockDefs=t,a.notifier=toastr,a.tt=function(e,t){if("undefined"!=typeof t)for(var i in t)t.hasOwnProperty(i)&&(e=e.replace(new RegExp("__"+i+"__","g"),t[i]));return e},a.t=a.tt,a.ut=function(e,t){return t},a.templatePath=i,a.remoteUrlProcessor=function(e){return e},a.remoteFileProcessor=function(e){return"undefined"!=typeof e.url&&(e.url=a.remoteUrlProcessor(e.url)),"undefined"!=typeof e.thumbnailUrl&&(e.thumbnailUrl=a.remoteUrlProcessor(e.thumbnailUrl)),e},a.loadGallery=function(){a.galleryLoaded("loading");var e=r?r:"/upload/";$.getJSON(e,function(e){for(var t=0;t<e.files.length;t++)e.files[t]=a.remoteFileProcessor(e.files[t]);a.galleryLoaded(e.files.length),a.galleryRemote(e.files.reverse())}).fail(function(){a.galleryLoaded(!1),a.notifier.error(a.t("Unexpected error listing files"))})},a.fileToImage=function(e,t,i){return e.url},a.removeBlock=function(e,t){ko.utils.unwrapObservable(a.selectedBlock)==ko.utils.unwrapObservable(e)&&a.selectBlock(null,!0);var i=t.blocks.remove(e);return a.notifier.info(a.t("Block removed: use undo button to restore it...")),i},a.duplicateBlock=function(e,t){var i=ko.utils.unwrapObservable(e),r=ko.toJS(ko.utils.unwrapObservable(t.blocks)[i]);"undefined"!=typeof r.id&&(r.id=""),t.blocks.splice(i+1,0,r)},a.moveBlock=function(e,t,i){var r=ko.utils.unwrapObservable(e),o=ko.utils.unwrapObservable(t.blocks);if(i&&r>0||!i&&r<o.length-1){var n=r+(i?-1:1),s=o[n];a.startMultiple(),t.blocks.splice(n,1),t.blocks.splice(r,0,s),a.stopMultiple()}},a.loadDefaultBlocks=function(){var e=ko.toJS(a.content().mainBlocks);e.blocks=[];for(var t=ko.utils.unwrapObservable(a.blockDefs),i=0;i<t.length;i++){var r=ko.toJS(t[i]);r.id="block_"+i,e.blocks.push(r)}performanceAwareCaller("setMainBlocks",a.content().mainBlocks._wrap.bind(a.content().mainBlocks,e))},a.addImage=function(e){var t=$("#main-wysiwyg-area .selectable-img.selecteditem");return 1==t.length&&"object"==typeof e&&"undefined"!=typeof e.url?(ko.contextFor(t[0])._src(e.url),!0):!1},a.addBlock=function(e,t){var r,i=a.selectedBlock();if(null!==i)for(var o=a.content().mainBlocks().blocks().length-1;o>=0;o--)if(a.content().mainBlocks().blocks()[o]()==i){r=o;break}var n;"undefined"!=typeof r?(n=r+1,a.content().mainBlocks().blocks.splice(n,0,e),a.notifier.info(a.t("New block added after the selected one (__pos__)",{pos:n}))):(a.content().mainBlocks().blocks.push(e),n=a.content().mainBlocks().blocks().length-1,a.notifier.info(a.t("New block added at the model bottom (__pos__)",{pos:n})));var s=a.content().mainBlocks().blocks()[n]();return a.selectBlock(s,!0),!1},a.findObjectsOfType=function(e,t){var i=[],r=ko.utils.unwrapObservable(e);for(var a in r)if(r.hasOwnProperty(a)){var o=ko.utils.unwrapObservable(r[a]);if(a.match(/Blocks$/))for(var n=ko.utils.unwrapObservable(o.blocks),s=0;s<n.length;s++){var l=ko.utils.unwrapObservable(n[s]);(null===t||ko.utils.unwrapObservable(l.type)==t)&&i.push(l)}else"object"==typeof o&&null!==o&&(null===t||ko.utils.unwrapObservable(o.type)==t)&&i.push(o)}return i},a.placeholderHelper={element:function(e){return $(e[0].outerHTML).removeClass("ui-draggable").addClass("sortable-placeholder").css("display","block").css("position","relative").css("width","100%").css("height","auto").css("opacity",".8")[0]},update:function(e,t){}},a.startMultiple=function(){"undefined"!=typeof a.setUndoModeMerge&&a.setUndoModeMerge()},a.stopMultiple=function(){"undefined"!=typeof a.setUndoModeOnce&&a.setUndoModeOnce()},a.localGlobalSwitch=function(e,t){var i=e();return e(null===i?t():null),!1},a.selectItem=function(e,t,i){var r=ko.utils.peekObservable(e);return"undefined"!=typeof i&&a.selectBlock(i,!1,!0),r!=t&&(e(t),null!==t&&0===a.selectedTool()&&a.selectedTool(1)),!1}.bind(a,a.selectedItem),a.isSelectedItem=function(e){return a.selectedItem()==e},a.selectBlock=function(e,t,i,r){var o=ko.utils.peekObservable(e);r||a.selectItem(null),o!=t&&(e(t),a.showGallery(!1),null===t||i||0!==a.selectedTool()||a.selectedTool(1))}.bind(a,a.selectedBlock),a.countSubscriptions=function(e,t){var i=0;for(var r in e)if(e.hasOwnProperty(r)){var o=e[r];if(ko.isObservable(o)&&("undefined"!=typeof o._defaultComputed&&("undefined"!=typeof t&&console.log(t+"/"+r+"/_",o._defaultComputed.getSubscriptionsCount()),i+=o._defaultComputed.getSubscriptionsCount()),"undefined"!=typeof t&&console.log(t+"/"+r+"/-",o.getSubscriptionsCount()),i+=o.getSubscriptionsCount(),o=ko.utils.unwrapObservable(o)),"object"==typeof o&&null!==o){var n=a.countSubscriptions(o,"undefined"!=typeof t?t+"/"+r+"@":void 0);"undefined"!=typeof t&&console.log(t+"/"+r+"@",n),i+=n}}return i},a.loopSubscriptionsCount=function(){var e=a.countSubscriptions(a.content());global.document.getElementById("subscriptionsCount").innerHTML=e,global.setTimeout(a.loopSubscriptionsCount,1e3)},a["export"]=function(){var e=performanceAwareCaller("exportHTML",a.exportHTML);return e},a.exportHTML=function(){var e="exportframe";$("body").append('<iframe id="'+e+'" data-bind="bindIframe: $data"></iframe>');var t=global.document.getElementById(e);ko.applyBindings(a,t),ko.cleanNode(t),a.inline&&a.inline(t.contentWindow.document);var i=t.contentWindow.document.doctype,r="<!DOCTYPE "+i.name+(i.publicId?' PUBLIC "'+i.publicId+'"':"")+(!i.publicId&&i.systemId?" SYSTEM":"")+(i.systemId?' "'+i.systemId+'"':"")+">",n=r+"\n"+t.contentWindow.document.documentElement.outerHTML;ko.removeNode(t),n=n.replace(/<script ([^>]* )?type="text\/html"[^>]*>[\s\S]*?<\/script>/gm,""),n=n.replace(/<!-- ko ((?!--).)*? -->/g,""),n=n.replace(/<!-- \/ko -->/g,""),n=n.replace(/ data-bind="[^"]*"/gm,""),n=n.replace(/ data-mce-(href|src|style)="[^"]*"/gm,""),n=n.replace(/ style="[^"]*"([^>]*) replaced(style="[^"]*")/gm,"$1 $2"),n=n.replace(/ replaced(style="[^"]*")([^>]*) style="[^"]*"/gm," $1$2"),n=n.replace(/ replaced(style="[^"]*")/gm," $1"),n=n.replace(/ http-equiv="[^"]*"([^>]*) replaced(http-equiv="[^"]*")/gm,"$1 $2"),n=n.replace(/ replaced(http-equiv="[^"]*")([^>]*) http-equiv="[^"]*"/gm," $1$2"),n=n.replace(/ replaced(http-equiv="[^"]*")/gm," $1"),n=o(n);var s=n.match(/ data-[^ =]+(="[^"]+")? /)||n.match(/ replaced([^= ]*=)/);return s&&console.warn("Output HTML contains unexpected data- attributes or replaced attributes",s),n},a.exportHTMLtoTextarea=function(e){$(e).val(a.exportHTML())},a.exportJSONtoTextarea=function(e){$(e).val(a.exportJSON())},a.importJSONfromTextarea=function(e){a.importJSON($(e).val())},a.exportMetadata=function(){var e=ko.toJSON(a.metadata);return e},a.exportJSON=function(){var e=ko.toJSON(a.content);return e},a.exportJS=function(){return ko.toJS(a.content)},a.importJSON=function(e){var t=ko.utils.parseJson(e);a.content._wrap(t)},a.exportTheme=function(){var e={},t=a.content().theme(),i=function(e,t,r){for(var a in r)if(r.hasOwnProperty(a)){var o=ko.utils.unwrapObservable(r[a]);null!==o&&"object"==typeof o?i(a+".",t,o):t[e+a]=o}};i("",e,t);var r="";for(var o in e)e.hasOwnProperty(o)&&"type"!=o&&(r+=o+": "+e[o]+";\n");return r},a.loadImage=function(e){a.galleryRecent.unshift(e),a.selectedImageTab(0)},a.dialog=function(e,t){$(e).dialog(t)},a.log=function(e,t){},a.selectedImageTab.subscribe(function(e){1==e&&a.galleryLoaded()===!1&&a.loadGallery()},a,"change"),a}var $=require("jquery"),ko=require("knockout"),console=require("console"),performanceAwareCaller=require("./timed-call.js").timedCall,toastr=require("toastr");toastr.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-full-width",target:"#mo-body",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},module.exports=initializeEditor;