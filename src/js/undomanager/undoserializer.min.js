"use strict";var ko=require("knockout"),console=require("console"),_reference=function(e,t){for(var r,n,i=0,o=e;i<t.length;)switch(t.charAt(i)){case"(":")"==t.charAt(i+1)&&(o=o()),i+=2;break;case"[":n=t.indexOf("]",i),o=o[t.substring(i+1,n)],i=n+1;break;case".":r=t.indexOf("(",i),-1==r&&(r=t.length),n=t.indexOf("[",i),-1==n&&(n=t.length),n=Math.min(r,n),o=o[t.substring(i+1,n)],i=n}return o},_getPath=function(e,t){for(var r,i="",n=0;n<=e.length;n++)if(r=n<e.length?e[n]:t,ko.isObservable(r)&&(i+="()"),"undefined"!=typeof r._fieldName)i+="."+r._fieldName;else{if(!(n>0&&"function"==typeof e[n-1].pop))throw console.error("Unexpected parent with no _fieldName and no parent array",n,e),"Unexpected parent with no _fieldName and no parent array";var o=ko.isObservable(e[n-1])?ko.utils.peekObservable(e[n-1]):e[n-1],a=ko.utils.arrayIndexOf(o,r);if(-1==a)throw console.error("Unexpected object not found in parent array",o,r,n,e.length,ko.toJS(o),ko.utils.unwrapObservable(r)),"Unexpected object not found in parent array";i+="["+a+"]"}return i},makeDereferencedUndoAction=function(e,t,i,r,n){var o=_reference(t,i);e(o,r,n)},listener,_setListener=function(e){listener=e},makeUndoActionDereferenced=function(e,t,i,r,n,o){try{var a=_getPath(i,r);if(("object"==typeof n||"function"==typeof n)&&(n=ko.toJS(n)),"undefined"!=typeof o&&("object"==typeof o.value||"function"==typeof o.value)){var s=ko.toJS(o);o=s}if("undefined"!=typeof listener)try{listener(a,r,n,o)}catch(l){console.log("Undoserializer ignoring exception in listener callback")}return makeDereferencedUndoAction.bind(void 0,t,e,a,n,o)}catch(l){console.error("Exception processing undo",l,i,r,o)}},watchEnabled,_watchEnabled=function(e){return"undefined"==typeof e?watchEnabled:void(watchEnabled=e)};module.exports={dereference:_getPath,reference:_reference,makeUndoAction:makeUndoActionDereferenced,setListener:_setListener,watchEnabled:_watchEnabled};