"use strict";var tinymce=require("tinymce"),$=require("jquery"),ko=require("knockout"),console=require("console");require("./eventable.js"),ko.bindingHandlers.wysiwygOrHtml={init:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;return o?ko.bindingHandlers.virtualHtml.init():ko.bindingHandlers.wysiwyg.init(e,t,i,r,n)},update:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;return o?ko.bindingHandlers.virtualHtml.update(e,t,i,r,n):void 0}},ko.virtualElements.allowedBindings.wysiwygOrHtml=!0,ko.bindingHandlers.wysiwygHref={init:function(e,t,i,r,n){if(8!==e.nodeType){var a=(t(),"undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode);if(a)e.setAttribute("target","_new");else{var s=i();"undefined"!=typeof s.wysiwygOrHtml?e.setAttribute("href","javascript:void(0)"):(e.removeAttribute("href"),e.setAttribute("disabledhref","#"))}}},update:function(e,t,i,r,n){if(8!==e.nodeType){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode,a=ko.utils.unwrapObservable(t());o&&(a===!1||null===a||void 0===a?e.removeAttribute("href"):e.setAttribute("href",a.toString()))}}},ko.virtualElements.allowedBindings.wysiwygHref=!0,ko.bindingHandlers.wysiwygSrc={convertedUrl:function(e,t,i,r){var n=-1==e.indexOf("?")?"?":"&",o=e+n+"method="+t+"&width="+i+(null!==r?"&height="+r:"");return o},placeholderUrl:function(e,t,i){},update:function(e,t,i,r,n){var o=ko.utils.unwrapObservable(t()),a=ko.utils.unwrapObservable(o.src),s=ko.utils.unwrapObservable(o.placeholder),l=ko.utils.unwrapObservable(o.width),d=ko.utils.unwrapObservable(o.height);if(a===!1||null===a||void 0===a||""===a)"object"==typeof s&&null!==s?e.setAttribute("src",ko.bindingHandlers.wysiwygSrc.placeholderUrl(s.width,s.height,s.text)):e.removeAttribute("src");else{var c=ko.utils.unwrapObservable(o.method);c||(c=l>0&&d>0?"cover":"resize");var u=ko.bindingHandlers.wysiwygSrc.convertedUrl(a.toString(),c,l,d);e.setAttribute("src",u)}"undefined"!=typeof l&&null!==l?e.setAttribute("width",l):e.removeAttribute("width"),"undefined"!=typeof d&&null!==d?e.setAttribute("height",d):e.removeAttribute("height")}},ko.bindingHandlers.wysiwygId={init:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;o||e.setAttribute("id",ko.utils.unwrapObservable(t()))},update:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;o||e.setAttribute("id",ko.utils.unwrapObservable(t()))}},ko.virtualElements.allowedBindings.wysiwygId=!0,ko.bindingHandlers.wysiwygClick={init:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;o||ko.bindingHandlers.click.init(e,t,i,r,n)}},ko.virtualElements.allowedBindings.wysiwygClick=!0,ko.bindingHandlers.wysiwygCss={update:function(e,t,i,r,n){var o="undefined"==typeof n.templateMode||"wysiwyg"!=n.templateMode;o||ko.bindingHandlers.css.update(e,t,i,r,n)}},ko.virtualElements.allowedBindings.wysiwygCss=!0,ko.bindingHandlers.wysiwygImg={makeTemplateValueAccessor:function(e,t){return function(){var i="undefined"!=typeof t.templateMode&&"wysiwyg"==t.templateMode,r=e(),n=ko.utils.peekObservable(r);return ko.utils.unwrapObservable(r),{name:i?n._editTemplate:n._template,templateEngine:ko.nativeTemplateEngine.instance}}},init:function(e,t,i,r,n){return ko.bindingHandlers.template.init(e,ko.bindingHandlers.wysiwygImg.makeTemplateValueAccessor(t,n))},update:function(e,t,i,r,n){return n=n.extend(t()),ko.bindingHandlers.template.update(e,ko.bindingHandlers.wysiwygImg.makeTemplateValueAccessor(t,n),i,r,n)}},ko.virtualElements.allowedBindings.wysiwygImg=!0,ko.bindingHandlers.wysiwyg={currentIndex:0,standardOptions:{},fullOptions:{toolbar1:"bold italic forecolor backcolor hr styleselect removeformat | link unlink | pastetext code",plugins:["link hr paste lists textcolor code"]},init:function(e,t,i,r,n){ko.bindingHandlers.focusable.init(e),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){tinymce.remove("#"+e.getAttribute("id"))});var o=t();if(!ko.isObservable(o))throw"Wysiwyg binding called with non observable";if(8===e.nodeType)throw"Wysiwyg binding called on virtual node, ignoring...."+e.innerHTML;var a=e.getAttribute("id");a||(a="wysiwyg_"+ ++ko.bindingHandlers.wysiwyg.currentIndex,e.setAttribute("id",a));var d,s="DIV"==e.tagName||"TD"==e.tagName,l=!1,c=!1,u={selector:"#"+a,inline:!0,hidden_input:!1,plugins:["paste"],toolbar1:"bold italic",toolbar2:"",preview_styles:!1,paste_as_text:!0,language:"en",schema:"html5",extended_valid_elements:"strong/b,em/i,*[*]",menubar:!1,skin:"gray-flat",setup:function(e){e.on("change redo undo",function(){l||(c=!0,o(e.getContent({format:"raw"})),c=!1)}),e.on("focus",function(){e.nodeChanged(),e.getElement().click()}),e.on("BeforeSetContent",function(e){e.initial&&(e.format="raw")}),d=e}};return ko.utils.extend(u,ko.bindingHandlers.wysiwyg.standardOptions),s&&ko.utils.extend(u,ko.bindingHandlers.wysiwyg.fullOptions),global.setTimeout(function(){tinymce.init(u)}),ko.computed(function(){var i=ko.utils.unwrapObservable(t());if(!c){try{l=!0,"undefined"!=typeof d?d.setContent(i,{format:"raw"}):ko.utils.setHtml(e,i)}catch(r){console.log("TODO exception setting content to editable element",typeof d,r)}l=!1}},null,{disposeWhenNodeIsRemoved:e}),{controlsDescendantBindings:!0}}};