"use strict";var express=require("express"),upload=require("jquery-file-upload-middleware"),bodyParser=require("body-parser"),fs=require("fs"),_=require("lodash"),app=express(),gm=require("gm").subClass({imageMagick:!0}),config=require("../server-config.js"),extend=require("util")._extend;app.use(require("connect-livereload")({ignore:[/^\/dl/]})),app.use(bodyParser.json({limit:"5mb"})),app.use(bodyParser.urlencoded({limit:"5mb",extended:!0}));var listFiles=function(e,t,r){var a=[],i=1,o=function(){--i||r(a)},n=e.protocol+"://"+e.get("host");fs.readdir(t.uploadDir,_.bind(function(e,r){_.each(r,function(e){var r=fs.statSync(t.uploadDir+"/"+e);if(r.isFile()){var s={name:e,url:n+t.uploadUrl+"/"+e,size:r.size};_.each(t.imageVersions,function(r,a){i++,fs.exists(t.uploadDir+"/"+a+"/"+e,function(r){r&&(s.thumbnailUrl=n+t.uploadUrl+"/"+a+"/"+e),o()})}),a.push(s)}},this),o()},this))},uploadOptions={tmpDir:".tmp",uploadDir:"./uploads",uploadUrl:"/uploads",imageVersions:{thumbnail:{width:90,height:90}}};app.get("/upload/",function(e,t){listFiles(e,uploadOptions,function(e){t.json({files:e})})}),app.use("/upload/",upload.fileHandler(uploadOptions)),app.get("/img/",function(e,t){var r=e.query.params.split(",");if("placeholder"==e.query.method){var a=gm(r[0],r[1],"#707070");t.set("Content-Type","image/png");for(var i=0,o=0,n=40;o<r[1];)a=a.fill("#808080").drawPolygon([i,o],[i+n,o],[i+2*n,o+n],[i+2*n,o+2*n]).drawPolygon([i,o+n],[i+n,o+2*n],[i,o+2*n]),i+=2*n,i>r[0]&&(i=0,o+=2*n);a=a.fill("#B0B0B0").fontSize(20).drawText(0,0,r[0]+" x "+r[1],"center"),a.stream("png").pipe(t)}else if("resize"==e.query.method){var s=gm(e.query.src);s.format(function(e,a){e||t.set("Content-Type","image/"+a.toLowerCase()),s.autoOrient().resize("null"==r[0]?null:r[0],"null"==r[1]?null:r[1]).stream().pipe(t)})}else if("cover"==e.query.method){var v=gm(e.query.src);v.format(function(e,a){e||t.set("Content-Type","image/"+a.toLowerCase()),v.autoOrient().resize(r[0],r[1]+"^").gravity("Center").extent(r[0],r[1]+">").stream().pipe(t)})}}),app.post("/dl/",function(e,t){var r=function(r){if("download"==e.body.action)t.setHeader("Content-disposition","attachment; filename="+e.body.filename),t.setHeader("Content-type","text/html"),t.write(r),t.end();else if("email"==e.body.action){var a=require("nodemailer"),i=a.createTransport(config.emailTransport),o=extend({to:e.body.rcpt,subject:e.body.subject,html:r},config.emailOptions);i.sendMail(o,function(e,r){e?(console.log(e),t.status(500).send("Error: "+e),t.write("ERR")):(console.log("Message sent: "+r.response),t.send("OK: "+r.response))})}};r(e.body.html)});var PORT=process.env.PORT||3e3;app.use(express["static"](__dirname+"/../"));var server=app.listen(PORT,function(){console.log("Express server listening on port "+PORT)});