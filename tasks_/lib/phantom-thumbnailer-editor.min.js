function setSize(e,t){pageWidth=parseInt(t[0],10),pageHeight=parseInt(t[1],10),e.viewportSize={width:pageWidth,height:pageHeight},e.clipRect={top:0,left:0,width:pageWidth,height:pageHeight}}function setClipRect(e,t,r,a){var i=t.height+2*r,o=t.width+2*r;o*a>i?o=i/a:i=o*a,console.log("clipRect",t.top-r,t.left-r,o,i),e.clipRect={top:t.top-r,left:t.left-r,width:o,height:i}}function has(e){var t=featureMap[e];return isFunction(proto[t])}var page=require("webpage").create(),system=require("system"),address,output,size,selector,margin,isFunction=function(e){return"function"==typeof e},bind,slice=[].slice,proto=Function.prototype,featureMap;featureMap={"function-bind":"bind"},has("function-bind")||(bind=function(e){var t=slice.call(arguments,1),r=this,a=function(){},i=function(){return r.apply(this instanceof a?this:e||{},t.concat(slice.call(arguments)))};return a.prototype=this.prototype||{},i.prototype=new a,i},proto.bind=bind),system.args.length<5||system.args.length>5?(console.log("Usage: thumbnailer.js renderWIDTH outputWIDTH URL destfolder"),phantom.exit(1)):(address=system.args[3],destFolder=system.args[4],size=[system.args[1],1e3],setSize(page,size),margin=0,page.onError=function(e,t){var r=["ERROR: "+e];t&&t.length&&(r.push("TRACE:"),t.forEach(function(e){r.push(" -> "+e.file+": "+e.line+(e["function"]?' (in function "'+e["function"]+'")':""))})),console.error(r.join("\n"))},page.open(address,function(e){"success"!==e?(console.log("Unable to load the address!"),phantom.exit()):(page.evaluate(function(){var e=document.getElementsByTagName("body")[0];e.setAttribute("class",e.getAttribute("class")+" preview")}),window.setTimeout(function(){var e=page.evaluate(function(){for(var e=document.querySelectorAll("[data-ko-container] [data-ko-block]"),t=[],r=0;r<e.length;r++)t.push(e[r].getAttribute("data-ko-block"));return t.push("_full"),t});console.log(e);for(var t=[],r=[],a=function(e){return document.querySelector(e).getBoundingClientRect()},i=0;i<e.length;i++){var o,n=e[i];o="_full"==n?"body":"[data-ko-block="+n+"]";var s=page.evaluate(a,o),v={};v.width=size[0],v.left=0,v.top=s.top,v.height=s.height,setClipRect(page,v,margin,v.height/v.width),r.push(v),t.push(page.renderBase64("PNG"))}i=0;var c=function(r,a){var o=e[i];page.onLoadFinished=function(t){var n=page.render(destFolder+"/"+o+".png");console.log("finished "+i+" "+n),i==e.length-1?(console.log("exiting"),n?phantom.exit():phantom.exit(1)):(i++,c(r,a))};var n=[a,Math.ceil(r[i].height/r[i].width*a)],s='<html><body style="margin: 0; background: #fff;"><img src="data:image/png;base64,'+t[i]+'" alt="N/A" width="'+n[0]+'" height="'+n[1]+'" /></body></html>';setSize(page,n),page.content=s};c(r,system.args[2])},2e3))}));